<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuckyPitch | Valós idejű Elemzés</title>
    <style>
        :root { 
            --primary: #00ff88; 
            --text: #f8fafc; 
            --box-bg: rgba(15, 23, 42, 0.95);
            --accent: #38bdf8;
        }

        body { background: #0f172a; color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .back-btn { display: inline-block; margin-bottom: 20px; color: var(--primary); text-decoration: none; font-weight: bold; }

        .match-card { 
            background: var(--box-bg); padding: 30px; border-radius: 20px; border: 1px solid rgba(0, 255, 136, 0.3); 
            display: flex; justify-content: space-around; align-items: center; margin-bottom: 30px; text-align: center;
        }
        .team-box img { width: 60px; height: 60px; object-fit: contain; }
        .score { font-size: 2.2rem; font-weight: 800; color: var(--primary); }

        .grid { display: grid; grid-template-columns: 1.6fr 1fr; gap: 20px; }
        @media (max-width: 850px) { .grid { grid-template-columns: 1fr; } }

        .card { background: var(--box-bg); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); }
        h3 { color: var(--primary); margin: 0 0 15px 0; font-size: 1.1rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }

        table { width: 100%; border-collapse: separate; border-spacing: 0 4px; font-size: 12px; }
        td { padding: 12px 10px; background: rgba(255,255,255,0.03); vertical-align: middle; }
        
        /* Dinamikus Zóna Csík */
        .status-cell { border-left: 4px solid transparent; }
        
        .zone-label { 
            font-size: 8px; 
            font-weight: 900; 
            display: block; 
            margin-bottom: 3px; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pos-circle { 
            display: inline-block; width: 22px; height: 22px; line-height: 22px; 
            text-align: center; border-radius: 50%; background: rgba(255,255,255,0.1); 
            font-size: 10px; font-weight: bold;
        }

        .highlight { background: rgba(0, 255, 136, 0.15) !important; outline: 1px solid var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <a href="/meccsek" class="back-btn">← VISSZA A MECCSEKHEZ</a>
    <div id="header-target"></div>

    <div class="grid">
        <div class="card">
            <h3>Hivatalos Bajnoki Rangsor</h3>
            <div id="standings-target">Adatok szinkronizálása...</div>
        </div>
        <div class="card">
            <h3>Élő Oddsok</h3>
            <div id="odds-target">Keresés...</div>
        </div>
    </div>
</div>

<script>
    const matchId = new URLSearchParams(window.location.search).get('id');

    async function init() {
        try {
            const res = await fetch('/live-matches');
            const data = await res.json();
            const match = data.matches.find(m => m.id == matchId);
            if (!match) return;

            renderHeader(match);
            loadStandings(match.competition.code, match.homeTeam.name, match.awayTeam.name);
            loadOdds(match.homeTeam.name, match.awayTeam.name);
        } catch (err) { console.error(err); }
    }

    function renderHeader(m) {
        document.getElementById('header-target').innerHTML = `
            <div class="match-card">
                <div class="team-box"><img src="${m.homeTeam.crest}"><h3>${m.homeTeam.name}</h3></div>
                <div class="score">${m.score.fullTime.home ?? 0} : ${m.score.fullTime.away ?? 0}</div>
                <div class="team-box"><img src="${m.awayTeam.crest}"><h3>${m.awayTeam.name}</h3></div>
            </div>`;
    }

    // Szín meghatározása a szöveg alapján (Dinamikus)
    function getStatusColor(text) {
        if (!text) return "transparent";
        text = text.toLowerCase();
        if (text.includes("champions league")) return "#007bff";
        if (text.includes("europa league")) return "#f39c12";
        if (text.includes("conference league")) return "#00ff88";
        if (text.includes("play-off") || text.includes("promotion")) return "#9b59b6";
        if (text.includes("relegation")) return "#e74c3c";
        return "#64748b";
    }

    // Magyarítás a leíráshoz
    function translateStatus(text) {
        if (!text) return "";
        return text
            .replace("Promotion", "Feljutás")
            .replace("Relegation", "Kiesés")
            .replace("Champions League", "BL")
            .replace("Europa League", "EL")
            .replace("Conference League", "KL")
            .replace("Group Stage", "Főtábla")
            .replace("Qualifiers", "Selejtező")
            .replace("Play-offs", "Rájátszás");
    }

    async function loadStandings(code, home, away) {
        try {
            const res = await fetch(`/api/standings/${code}`);
            const data = await res.json();
            
            // Az API "standings" tömbjében keressük a "TOTAL" típusút
            const standings = data.standings.find(s => s.type === 'TOTAL');
            const table = standings.table;

            let html = `<table><tbody>`;
            table.forEach(r => {
                // Itt a kulcs: r.description tartalmazza a HIVATALOS kupahelyet
                const statusText = r.description || ""; 
                const color = getStatusColor(statusText);
                const isM = (r.team.name === home || r.team.name === away);

                html += `
                    <tr class="${isM ? 'highlight' : ''}">
                        <td class="status-cell" style="border-left-color: ${color}">
                            ${statusText ? `<span class="zone-label" style="color:${color}">${translateStatus(statusText)}</span>` : ''}
                            <span class="pos-circle">${r.position}</span>
                        </td>
                        <td><img src="${r.team.crest}" width="18" style="margin-right:8px; vertical-align:middle;"> ${r.team.name}</td>
                        <td style="text-align:center">${r.playedGames}</td>
                        <td style="text-align:right"><b>${r.points}p</b></td>
                    </tr>`;
            });

            document.getElementById('standings-target').innerHTML = html + `</tbody></table>`;
        } catch (e) { 
            document.getElementById('standings-target').innerHTML = "A tabella jelenleg nem érhető el ehhez a ligához."; 
        }
    }

    async function loadOdds(home, away) {
        try {
            const res = await fetch('/api/odds-data');
            const data = await res.json();
            const m = data.find(o => o.home_team.includes(home.split(' ')[0]) || o.away_team.includes(away.split(' ')[0]));
            if (m) {
                const out = m.bookmakers[0].markets[0].outcomes;
                document.getElementById('odds-target').innerHTML = `
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:10px;">
                        <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; text-align:center;">
                            <small style="display:block; opacity:0.6; font-size:9px;">H</small>
                            <span style="color:var(--primary); font-weight:bold;">${out[0].price}</span>
                        </div>
                        <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; text-align:center;">
                            <small style="display:block; opacity:0.6; font-size:9px;">D</small>
                            <span style="color:var(--primary); font-weight:bold;">${out[1].price}</span>
                        </div>
                        <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; text-align:center;">
                            <small style="display:block; opacity:0.6; font-size:9px;">V</small>
                            <span style="color:var(--primary); font-weight:bold;">${out[2].price}</span>
                        </div>
                    </div>`;
            } else { document.getElementById('odds-target').innerHTML = "Nincs odds."; }
        } catch (e) { document.getElementById('odds-target').innerHTML = "Hiba."; }
    }
    init();
</script>
</body>
</html>
