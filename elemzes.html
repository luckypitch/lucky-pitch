<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuckyPitch | Profi Elemző Központ</title>
    <style>
        :root { 
            --primary: #00ff88; 
            --text: #f8fafc; 
            --box-bg: rgba(15, 23, 42, 0.98);
            --cl: #007bff;   /* Bajnokok Ligája - Sötétkék */
            --el: #f39c12;   /* Európa-liga - Narancs */
            --ecl: #00ff88;  /* Konferencia Liga - Zöld */
            --po: #9b59b6;   /* Osztályozó / Play-off - Lila */
            --rel: #e74c3c;  /* Kiesés - Piros */
        }

        body { 
            background: #0f172a; 
            color: var(--text); 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            margin: 0; 
            padding: 20px; 
            line-height: 1.4;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        .back-btn { 
            display: inline-block; 
            margin-bottom: 20px; 
            color: var(--primary); 
            text-decoration: none; 
            font-weight: bold; 
            font-size: 14px;
            transition: 0.3s;
        }
        .back-btn:hover { opacity: 0.7; transform: translateX(-5px); }

        /* Meccs fejléc kártya */
        .match-card { 
            background: var(--box-bg); 
            padding: 30px; 
            border-radius: 20px; 
            border: 1px solid rgba(0, 255, 136, 0.2); 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            margin-bottom: 30px; 
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .team-box { flex: 1; }
        .team-box img { width: 70px; height: 70px; object-fit: contain; margin-bottom: 10px; }
        .team-box h3 { margin: 0; font-size: 1.3rem; font-weight: 600; }
        .score { font-size: 2.8rem; font-weight: 800; color: var(--primary); flex: 1; }

        .grid { display: grid; grid-template-columns: 1.8fr 1fr; gap: 25px; }
        @media (max-width: 950px) { .grid { grid-template-columns: 1fr; } }

        .card { 
            background: var(--box-bg); 
            padding: 25px; 
            border-radius: 15px; 
            border: 1px solid rgba(255,255,255,0.1); 
        }

        h3.title { 
            color: var(--primary); 
            margin-top: 0; 
            margin-bottom: 20px; 
            font-size: 1.1rem; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }

        /* Tabella stílusok */
        table { width: 100%; border-collapse: separate; border-spacing: 0 5px; font-size: 13px; }
        th { text-align: left; padding: 10px; opacity: 0.5; font-weight: 400; }
        td { padding: 12px 10px; background: rgba(255,255,255,0.02); vertical-align: middle; }
        
        .status-cell { border-left: 4px solid transparent; }
        
        .zone-label { 
            font-size: 8px; 
            font-weight: 900; 
            display: block; 
            margin-bottom: 3px; 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
        }

        .pos-circle { 
            display: inline-block; width: 22px; height: 22px; line-height: 22px; 
            text-align: center; border-radius: 50%; background: rgba(255,255,255,0.1); 
            font-size: 11px; font-weight: bold;
        }

        .highlight { 
            background: rgba(0, 255, 136, 0.12) !important; 
            outline: 1px solid var(--primary);
        }

        /* Jelmagyarázat */
        .legend { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 15px; 
            margin-top: 20px; 
            padding: 15px; 
            background: rgba(255,255,255,0.03); 
            border-radius: 10px; 
            font-size: 11px;
        }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .dot { width: 10px; height: 10px; border-radius: 3px; }

        /* Odds stílus */
        .odds-list { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 15px; }
        .odd-item { 
            background: rgba(255,255,255,0.03); 
            padding: 18px; 
            border-radius: 12px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .odd-name { font-weight: 500; opacity: 0.8; }
        .odd-val { color: var(--primary); font-size: 1.4rem; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <a href="/meccsek" class="back-btn">← VISSZA A MECCSEKHEZ</a>
    
    <div id="header-target">
        <div class="match-card">Meccs betöltése...</div>
    </div>

    <div class="grid">
        <div class="card">
            <h3 class="title">Bajnoki Tabella & Kupák</h3>
            <div id="standings-target">Adatok lekérése...</div>
            
            <div class="legend">
                <div class="legend-item"><div class="dot" style="background:var(--cl)"></div> BL</div>
                <div class="legend-item"><div class="dot" style="background:var(--el)"></div> EL</div>
                <div class="legend-item"><div class="dot" style="background:var(--ecl)"></div> KL / Rájátszás</div>
                <div class="legend-item"><div class="dot" style="background:var(--po)"></div> Osztályozó</div>
                <div class="legend-item"><div class="dot" style="background:var(--rel)"></div> Kiesés</div>
            </div>
        </div>
        
        <div class="card">
            <h3 class="title">Piaci Esélyek (1X2)</h3>
            <div id="odds-target">Oddsok keresése...</div>
        </div>
    </div>
</div>

<script>
    const matchId = new URLSearchParams(window.location.search).get('id');

    // Szín meghatározása a szöveg vagy kategória alapján
    function getStatusColor(text) {
        if (!text) return "transparent";
        text = text.toLowerCase();
        if (text.includes("champions league") || text.includes("premier league")) return "var(--cl)";
        if (text.includes("europa league")) return "var(--el)";
        if (text.includes("conference league") || text.includes("ecl")) return "var(--ecl)";
        if (text.includes("play-off") || text.includes("promotion")) return "var(--po)";
        if (text.includes("relegation")) return "var(--rel)";
        return "#475569";
    }

    // Szövegek magyarítása
    function translateStatus(text) {
        if (!text) return "";
        return text
            .replace(/Promotion to/g, "Feljutás:")
            .replace(/Promotion/g, "Feljutás")
            .replace(/Relegation to/g, "Kiesés:")
            .replace(/Relegation/g, "Kiesés")
            .replace(/Champions League/g, "BL")
            .replace(/Europa League/g, "EL")
            .replace(/Conference League/g, "KL")
            .replace(/Group Stage/g, "(Főtábla)")
            .replace(/Qualifiers/g, "(Selejt.)")
            .replace(/Play-offs/g, "Rájátszás")
            .replace(/Semi-finals/g, "Elődöntő");
    }

    async function init() {
        try {
            const res = await fetch('/live-matches');
            const data = await res.json();
            const match = data.matches.find(m => m.id == matchId);

            if (!match) {
                document.getElementById('header-target').innerHTML = "Meccs nem található.";
                return;
            }

            // Fejléc render
            document.getElementById('header-target').innerHTML = `
                <div class="match-card">
                    <div class="team-box"><img src="${match.homeTeam.crest}"><h3>${match.homeTeam.name}</h3></div>
                    <div class="score">${match.score.fullTime.home ?? 0} : ${match.score.fullTime.away ?? 0}</div>
                    <div class="team-box"><img src="${match.awayTeam.crest}"><h3>${match.awayTeam.name}</h3></div>
                </div>`;

            loadStandings(match.competition.code, match.homeTeam.name, match.awayTeam.name);
            loadOdds(match.homeTeam.name, match.awayTeam.name);
        } catch (err) {
            console.error(err);
        }
    }

    async function loadStandings(code, home, away) {
        try {
            const res = await fetch(`/api/standings/${code}`);
            const data = await res.json();
            const table = data.standings.find(s => s.type === 'TOTAL').table;
            const total = table.length;

            let html = `<table><thead><tr><th>#</th><th>Csapat</th><th>M</th><th>P</th></tr></thead><tbody>`;

            table.forEach(r => {
                let status = r.description || "";
                const pos = r.position;

                // --- MANUÁLIS KIEGÉSZÍTÉS (Ha az API nem adja meg) ---
                if (!status) {
                    if (code === 'ELC') { // Championship
                        if (pos <= 2) status = "Promotion - Premier League";
                        else if (pos >= 3 && pos <= 6) status = "Championship (Play Off: Semi-finals)";
                        else if (pos >= total - 2) status = "Relegation - League One";
                    } 
                    else if (code === 'DED') { // Holland Eredivisie
                        if (pos === 1) status = "Champions League (Group Stage)";
                        else if (pos === 2) status = "Champions League (Qualifiers)";
                        else if (pos === 3) status = "Europa League (Qualifiers)";
                        else if (pos >= 4 && pos <= 7) status = "Conference League (Play-offs)";
                        else if (pos === 16) status = "Eredivisie (Osztályozó)";
                        else if (pos >= 17) status = "Kiesés - Eerste Divisie";
                    }
                    else if (code === 'FL1') { // Francia Ligue 1
                        if (pos <= 3) status = "Champions League (Group Stage)";
                        else if (pos === 4) status = "Champions League (Qualifiers)";
                        else if (pos === 16) status = "Ligue 1 (Osztályozó - Play Offs)";
                        else if (pos >= 17) status = "Kiesés - Ligue 2";
                    }
                    else if (['PL', 'PD', 'SA', 'BL1'].includes(code)) { // Top ligák
                        if (pos <= 4) status = "Champions League (Group Stage)";
                        else if (pos === 5) status = "Europa League (Group Stage)";
                        else if (pos >= total - 2) status = "Relegation";
                    }
                }

                const color = getStatusColor(status);
                // Intelligens név-összehasonlítás
                const isMatchTeam = (home.includes(r.team.name) || r.team.name.includes(home) || away.includes(r.team.name) || r.team.name.includes(away));

                html += `
                    <tr class="${isMatchTeam ? 'highlight' : ''}">
                        <td class="status-cell" style="border-left-color: ${color}">
                            ${status ? `<span class="zone-label" style="color:${color}">${translateStatus(status)}</span>` : ''}
                            <span class="pos-circle">${pos}</span>
                        </td>
                        <td><img src="${r.team.crest}" width="18" style="vertical-align:middle; margin-right:8px;"> ${r.team.name}</td>
                        <td>${r.playedGames}</td>
                        <td style="text-align:right"><b>${r.points}p</b></td>
                    </tr>`;
            });

            document.getElementById('standings-target').innerHTML = html + `</tbody></table>`;
        } catch (e) {
            document.getElementById('standings-target').innerHTML = "Tabella adat nem elérhető.";
        }
    }

    async function loadOdds(home, away) {
        try {
            const res = await fetch('/api/odds-data');
            const data = await res.json();
            
            // Okosabb névkeresés (pl. "Manchester City FC" -> "Manchester")
            const homeBase = home.split(' ')[0];
            const matchOdds = data.find(o => o.home_team.includes(homeBase) || o.away_team.includes(homeBase));

            if (matchOdds && matchOdds.bookmakers[0]) {
                const outcomes = matchOdds.bookmakers[0].markets[0].outcomes;
                
                // Megkeressük az 1, X, 2 értékeket név alapján
                const hOdd = outcomes.find(o => o.name === matchOdds.home_team)?.price || '-';
                const dOdd = outcomes.find(o => o.name === 'Draw')?.price || '-';
                const aOdd = outcomes.find(o => o.name === matchOdds.away_team)?.price || '-';

                document.getElementById('odds-target').innerHTML = `
                    <div class="odds-list">
                        <div class="odd-item"><span class="odd-name">Hazai (1)</span><span class="odd-val">${hOdd}</span></div>
                        <div class="odd-item"><span class="odd-name">Döntetlen (X)</span><span class="odd-val">${dOdd}</span></div>
                        <div class="odd-item"><span class="odd-name">Vendég (2)</span><span class="odd-val">${aOdd}</span></div>
                    </div>
                    <p style="text-align:center; font-size:10px; opacity:0.4; margin-top:20px;">Forrás: ${matchOdds.bookmakers[0].title}</p>`;
            } else {
                document.getElementById('odds-target').innerHTML = "<div class='odd-item'>Jelenleg nincs elérhető odds.</div>";
            }
        } catch (e) {
            document.getElementById('odds-target').innerHTML = "Hiba az oddsok betöltésekor.";
        }
    }

    init();
</script>

</body>
</html>
