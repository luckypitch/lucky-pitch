<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuckyPitch | Elemzés Pro</title>
    <style>
        :root { 
            --primary: #00ff88; 
            --text: #f8fafc; 
            --box-bg: rgba(15, 23, 42, 0.98);
            --cl-gs: #0044ff; --cl-q: #6699ff;
            --el-gs: #cc7a00; --el-q: #800020;
            --ecl-q: #b8860b; --po: #d35400; --rel: #e74c3c;
        }
        body { background: #0f172a; color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 15px; }
        .container { max-width: 1300px; margin: 0 auto; }
        
        .match-card { 
            background: var(--box-bg); padding: 20px; border-radius: 15px; border: 1px solid rgba(0, 255, 136, 0.2); 
            display: flex; justify-content: space-around; align-items: center; margin-bottom: 20px; text-align: center; 
        }
        .score { font-size: 2rem; font-weight: 800; color: var(--primary); }

        .grid { display: grid; grid-template-columns: 2.5fr 1fr; gap: 20px; }
        @media (max-width: 1100px) { .grid { grid-template-columns: 1fr; } }

        .card { background: var(--box-bg); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); overflow-x: auto; }
        
        /* TÁBLÁZAT FIXÁLÁSA */
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 700px; }
        th { background: rgba(255,255,255,0.03); padding: 12px 8px; color: #94a3b8; font-weight: 600; text-align: center; }
        td { padding: 12px 8px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }

        .team-col { text-align: left; min-width: 180px; }
        .pos-col { width: 60px; text-align: center; position: relative; }
        
        /* Zóna és Helyezés egy oszlopban */
        .status-border { border-left: 4px solid transparent; }
        .zone-tag { font-size: 8px; font-weight: 900; display: block; line-height: 1; margin-bottom: 3px; }
        .pos-num { display: inline-block; width: 22px; height: 22px; line-height: 22px; background: rgba(255,255,255,0.1); border-radius: 50%; font-weight: bold; }

        .highlight { background: rgba(0, 255, 136, 0.08) !important; }
        .pts-bold { font-weight: 800; background: rgba(255,255,255,0.03); }

        .legend { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; font-size: 10px; opacity: 0.8; }
        .dot { width: 10px; height: 10px; border-radius: 2px; display: inline-block; margin-right: 4px; }
    </style>
</head>
<body>

<div class="container">
    <div id="header-target"></div>

    <div class="grid">
        <div class="card">
            <h3 style="color:var(--primary); margin-top:0;">Bajnoki Tabella</h3>
            <div id="standings-target">Betöltés...</div>
            <div class="legend" id="legend-target"></div>
        </div>

        <div class="card">
            <h3 style="color:var(--primary); margin-top:0;">Élő Oddsok</h3>
            <div id="odds-target"></div>
        </div>
    </div>
</div>

<script>
    const matchId = new URLSearchParams(window.location.search).get('id');

    function getStatusColor(text) {
        if (!text) return "transparent";
        text = text.toLowerCase();
        if (text.includes("champions league")) return text.includes("qualifiers") ? "var(--cl-q)" : "var(--cl-gs)";
        if (text.includes("europa league")) return "var(--el-q)";
        if (text.includes("conference league")) return "var(--ecl-q)";
        if (text.includes("play-off") || text.includes("promotion")) return "var(--po)";
        if (text.includes("relegation") || text.includes("kiesés")) return "var(--rel)";
        return "transparent";
    }

    function translateStatus(text) {
        if (!text) return "";
        if (text.includes("Champions League")) return "BL";
        if (text.includes("Europa League")) return "EL";
        if (text.includes("Conference League")) return "KL";
        if (text.includes("Relegation")) return "KIESŐ";
        if (text.includes("Promotion")) return "FELJ.";
        return "ZÓNA";
    }

    async function init() {
        const res = await fetch('/live-matches');
        const data = await res.json();
        const match = data.matches.find(m => m.id == matchId);
        if (!match) return;

        document.getElementById('header-target').innerHTML = `
            <div class="match-card">
                <div><img src="${match.homeTeam.crest}" width="50"><br><b>${match.homeTeam.name}</b></div>
                <div class="score">${match.score.fullTime.home ?? 0} : ${match.score.fullTime.away ?? 0}</div>
                <div><img src="${match.awayTeam.crest}" width="50"><br><b>${match.awayTeam.name}</b></div>
            </div>`;

        loadStandings(match.competition.code, match.homeTeam.name, match.awayTeam.name);
    }

    async function loadStandings(code, home, away) {
        try {
            const res = await fetch(`/api/standings/${code}`);
            const data = await res.json();
            const table = data.standings[0].table;
            const total = table.length;

            let html = `<table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th class="team-col">Csapat</th>
                        <th>MP</th>
                        <th>GY</th>
                        <th>D</th>
                        <th>V</th>
                        <th>GÓL</th>
                        <th>GK</th>
                        <th>P</th>
                    </tr>
                </thead>
                <tbody>`;

            table.forEach(r => {
                let status = r.description || "";
                const pos = r.position;

                // Manuális szabályok ha az API nem küldi (pl. PPL)
                if (!status && code === 'PPL') {
                    if (pos === 1) status = "Champions League";
                    else if (pos === 2) status = "Champions League Qualifiers";
                    else if (pos === 3) status = "Europa League Qualifiers";
                    else if (pos === 16) status = "Play-off";
                    else if (pos >= 17) status = "Relegation";
                }

                const color = getStatusColor(status);
                const isMatchTeam = (home.includes(r.team.name) || r.team.name.includes(home) || away.includes(r.team.name) || r.team.name.includes(away));

                html += `
                    <tr class="${isMatchTeam ? 'highlight' : ''}">
                        <td class="pos-col status-border" style="border-left-color: ${color}">
                            ${status ? `<span class="zone-tag" style="color:${color}">${translateStatus(status)}</span>` : ''}
                            <span class="pos-num">${pos}</span>
                        </td>
                        <td class="team-col">
                            <img src="${r.team.crest}" width="16" style="vertical-align:middle; margin-right:8px;">
                            ${r.team.name}
                        </td>
                        <td>${r.playedGames}</td>
                        <td>${r.won}</td>
                        <td>${r.draw}</td>
                        <td>${r.lost}</td>
                        <td>${r.goalsFor}:${r.goalsAgainst}</td>
                        <td style="color: ${r.goalDifference > 0 ? '#00ff88' : r.goalDifference < 0 ? '#ff4d4d' : 'inherit'}">
                            ${r.goalDifference > 0 ? '+' + r.goalDifference : r.goalDifference}
                        </td>
                        <td class="pts-bold">${r.points}</td>
                    </tr>`;
            });
            document.getElementById('standings-target').innerHTML = html + "</tbody></table>";
        } catch (e) { document.getElementById('standings-target').innerHTML = "Hiba."; }
    }
    init();
</script>
</body>
</html>
