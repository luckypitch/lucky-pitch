<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>LuckyPitch | Elemzés</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --primary: #00ff88; --text: #f8fafc; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* Meccs fejléce */
        .match-header { 
            background: var(--card); padding: 30px; border-radius: 20px; 
            display: flex; justify-content: space-around; align-items: center;
            margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }
        .team-big { flex: 1; }
        .team-big img { width: 80px; height: 80px; margin-bottom: 10px; }
        .score-big { font-size: 3rem; font-weight: bold; color: var(--primary); flex: 1; }

        /* Rács elrendezés az adatoknak */
        .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .info-card { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.05); }
        h3 { color: var(--primary); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; margin-top: 0; }

        /* Tabella stílus */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; opacity: 0.6; padding: 8px; }
        td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .highlight { background: rgba(0, 255, 136, 0.1); font-weight: bold; }

        /* Odds gombok */
        .odds-container { display: flex; gap: 10px; margin-top: 10px; }
        .odd-box { 
            flex: 1; background: rgba(255,255,255,0.05); padding: 10px; 
            border-radius: 8px; text-align: center; border: 1px solid var(--primary);
        }
        
        .back-btn { text-decoration: none; color: var(--primary); font-weight: bold; display: inline-block; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container">
    <a href="/meccsek" class="back-btn">← Vissza a meccsekhez</a>
    
    <div id="match-display">Betöltés...</div>

    <div class="analysis-grid">
        <div class="info-card">
            <h3>Bajnoki Helyezések</h3>
            <div id="standings-table">Adatok lekérése...</div>
        </div>

        <div class="info-card">
            <h3>Fogadási Esélyek (Odds)</h3>
            <div id="odds-display">Nincs elérhető odds.</div>
        </div>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const matchId = urlParams.get('id');

    async function loadAnalysis() {
        if (!matchId) return;

        try {
            // 1. Meccs adatainak lekérése
            const res = await fetch('/live-matches');
            const data = await res.json();
            const match = data.matches.find(m => m.id == matchId);

            if (!match) {
                document.getElementById('match-display').innerHTML = "Meccs nem található.";
                return;
            }

            renderHeader(match);
            loadStandings(match.competition.code, match.homeTeam.name, match.awayTeam.name);
            loadOdds(match.homeTeam.name, match.awayTeam.name);

        } catch (e) {
            console.error(e);
        }
    }

    function renderHeader(m) {
        document.getElementById('match-display').innerHTML = `
            <div class="match-header">
                <div class="team-big">
                    <img src="${m.homeTeam.crest}" alt="logo">
                    <h2>${m.homeTeam.name}</h2>
                </div>
                <div class="score-big">${m.score.fullTime.home ?? 0} : ${m.score.fullTime.away ?? 0}</div>
                <div class="team-big">
                    <img src="${m.awayTeam.crest}" alt="logo">
                    <h2>${m.awayTeam.name}</h2>
                </div>
            </div>
        `;
    }

    async function loadStandings(leagueCode, homeTeam, awayTeam) {
        const container = document.getElementById('standings-table');
        try {
            const res = await fetch(`/api/standings/${leagueCode}`);
            const data = await res.json();
            const table = data.standings[0].table;

            let html = `<table><tr><th>#</th><th>Csapat</th><th>M</th><th>P</th></tr>`;
            table.forEach(row => {
                const isMatch = (row.team.name === homeTeam || row.team.name === awayTeam);
                html += `
                    <tr class="${isMatch ? 'highlight' : ''}">
                        <td>${row.position}</td>
                        <td>${row.team.name}</td>
                        <td>${row.playedGames}</td>
                        <td>${row.points}</td>
                    </tr>
                `;
            });
            html += `</table>`;
            container.innerHTML = html;
        } catch (e) { container.innerHTML = "Tabella nem elérhető."; }
    }

    async function loadOdds(homeTeam, awayTeam) {
        const container = document.getElementById('odds-display');
        try {
            const res = await fetch('/api/odds-data');
            const oddsData = await res.json();
            
            // Megkeressük a konkrét meccset az oddsok között (név egyezés alapján)
            const matchOdds = oddsData.find(o => 
                o.home_team.includes(homeTeam.split(' ')[0]) || 
                o.away_team.includes(awayTeam.split(' ')[0])
            );

            if (matchOdds && matchOdds.bookmakers[0]) {
                const markets = matchOdds.bookmakers[0].markets[0].outcomes;
                container.innerHTML = `
                    <p>Iroda: ${matchOdds.bookmakers[0].title}</p>
                    <div class="odds-container">
                        <div class="odd-box">H: ${markets.find(x => x.name === matchOdds.home_team).price}</div>
                        <div class="odd-box">D: ${markets.find(x => x.name === 'Draw')?.price || '-'}</div>
                        <div class="odd-box">V: ${markets.find(x => x.name === matchOdds.away_team).price}</div>
                    </div>
                `;
            }
        } catch (e) { container.innerHTML = "Oddsok betöltése sikertelen."; }
    }

    loadAnalysis();
</script>
</body>
</html>
