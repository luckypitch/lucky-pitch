<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LuckyPitch | Ultimate Live Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script async crossorigin="anonymous" data-clerk-publishable-key="pk_test_YWxsb3dlZC1pbnNlY3QtOTguY2xlcmsuYWNjb3VudHMuZGV2JA" src="https://allowed-insect-98.clerk.accounts.dev/npm/@clerk/clerk-js@latest/dist/clerk.browser.js" type="text/javascript"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6426879392195114"
     crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;500;800&display=swap" rel="stylesheet">
    <style>
    :root {
        --bg: #020617;
        --glass: rgba(15, 23, 42, 0.75);
        --neon-green: #00ff88;
        --neon-blue: #0ea5e9;
        --neon-red: #ff3e3e;
        --text: #f1f5f9;
        --border: rgba(255, 255, 255, 0.1);
        --cl-gs: #0044ff; --el-gs: #cc7a00; --ecl-q: #00cc6a; --po: #d35400; --rel: #ff3e3e;
    }

    body.light {
        --bg: #f8fafc;
        --glass: rgba(255, 255, 255, 0.85);
        --text: #0f172a;
        --border: rgba(0, 0, 0, 0.1);
        --neon-blue: #0284c7;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body { 
        background: var(--bg); 
        color: var(--text); 
        font-family: 'Inter', sans-serif; 
        height: 100vh; 
        overflow-x: hidden; 
        position: relative; 
        transition: background 0.5s; 
    }

    /* --- H√°tt√©r Anim√°ci√≥k (Visszahozva az eredetib≈ël) --- */
    .bg-animation { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; filter: blur(100px); opacity: 0.5; }
    .blob { position: absolute; width: 600px; height: 600px; border-radius: 50%; mix-blend-mode: screen; animation: move 25s infinite alternate ease-in-out; }
    .blob-1 { background: var(--cl-gs); top: -10%; left: -10%; }
    .blob-2 { background: var(--neon-green); bottom: -10%; right: -10%; animation-delay: -5s; }
    .blob-3 { background: var(--el-gs); top: 30%; left: 30%; animation-delay: -10s; }
    @keyframes move { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(10vw, 10vh) scale(1.2); } }

    /* --- Banner & Navig√°ci√≥ --- */
    #goal-banner {
        position: fixed; top: -100px; left: 0; right: 0; height: 65px; z-index: 9999 !important;
        background: var(--neon-green); color: #000; display: flex; align-items: center; justify-content: center;
        font-family: 'Orbitron'; font-weight: 900; font-size: 1.6rem;
        transition: 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 0 50px rgba(0,255,136,0.6);
    }
    #goal-banner.show { top: 75px; }

    nav { 
        position: fixed; top: 0; left: 0; right: 0; height: 75px; 
        display: flex; justify-content: space-between; align-items: center; 
        padding: 0 30px; background: var(--glass); backdrop-filter: blur(20px); 
        border-bottom: 1px solid var(--border); z-index: 2000; 
    }

    .logo { font-family: 'Orbitron'; font-weight: 900; font-size: 1.4rem; color: var(--neon-blue); letter-spacing: 3px; }
    .nav-tools { display: flex; align-items: center; gap: 12px; }

    .tool-btn { 
        background: rgba(255,255,255,0.05); border: 1px solid var(--border);
        color: var(--text); padding: 10px 16px; border-radius: 10px;
        cursor: pointer; font-family: 'Orbitron'; font-size: 11px; transition: 0.3s;
        display: flex; align-items: center; justify-content: center;
    }
    .tool-btn:hover { border-color: var(--neon-blue); background: rgba(14, 165, 233, 0.2); }

    /* --- Elrendez√©s --- */
  .main-wrapper { 
    display: flex;
    margin-top: 75px;
    /* Csak a becsukott √°llapot sz√©less√©g√©t foglalja le fixen */
    padding-left: 80px; 
    min-height: calc(100vh - 75px);
    transition: none; /* Ne legyen √°tmenet a paddingen, hogy ne mozogjanak a k√°rty√°k */
}
.main-wrapper:has(.sidebar:hover),
.main-wrapper:has(.sidebar.open) {
    padding-left: 80px; 
}
.sidebar { 
    width: 80px;
    position: fixed;
    top: 75px;
    left: 0;
    bottom: 0;
    background: var(--glass); 
    backdrop-filter: blur(25px); 
    border-right: 1px solid var(--border); 
    z-index: 2000; /* Magasabb z-index, hogy a k√°rty√°k felett legyen */
    overflow-x: hidden; 
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s; 
}
        
/* NYITOTT √ÅLLAPOT */
.sidebar:hover, 
.sidebar.open { 
    width: 280px;
    /* √Årny√©k hozz√°ad√°sa kinyit√°skor, hogy jobban elv√°ljon a tartalomt√≥l */
    box-shadow: 20px 0 50px rgba(0, 0, 0, 0.5);
}

/* G√ñRD√çT≈êS√ÅV ELREJT√âSE */
.sidebar::-webkit-scrollbar { width: 0; }

/* --- SIDEBAR HEADER (KUPA) --- */
.sidebar-header { 
    width: 100%;
    height: 75px;
    display: flex; 
    align-items: center; 
    justify-content: center; /* Becsukva k√∂z√©pen a kupa */
    padding: 0;
    border-bottom: 1px solid var(--border);
    transition: all 0.5s ease;
}
        
/* Nyitott √°llapotban a fejl√©c eltol√°sa */
.sidebar:hover .sidebar-header,
.sidebar.open .sidebar-header {
    justify-content: flex-start;
    padding: 0 25px;
}
.header-emoji {
    font-size: 1.8rem;
    min-width: 46px;
    display: flex;
    justify-content: center;
    flex-shrink: 0;
}
        
    .standings-sidebar { 
        position: fixed; right: 0; top: 75px; bottom: 0; width: 400px; 
        z-index: 1500; background: var(--bg); border-left: 1px solid var(--border); 
        transform: translateX(100%); transition: transform 0.3s ease; padding: 20px; overflow-y: auto;
    }
    .standings-sidebar.open { transform: translateX(0); }

  .content-area { 
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 25px;
    width: 100%;
}
    #match-container { 
    width: 100%;
    max-width: 850px; /* Be√°ll√≠tja a k√°rty√°k maxim√°lis sz√©less√©g√©t */
    margin: 0 auto;   /* Biztos√≠tja a k√∂z√©ps≈ë igaz√≠t√°st */
}

    /* --- Meccsk√°rty√°k (Jav√≠tott Strukt√∫ra) --- */
    .match-card {
        background: rgba(30, 41, 59, 0.4); border: 1px solid var(--border); border-radius: 24px;
        padding: 25px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 20px;
        transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .match-card:hover { border-color: var(--neon-blue); background: rgba(30, 41, 59, 0.6); transform: translateY(-4px); }

    .match-info-row { display: flex; align-items: center; justify-content: space-between; width: 100%; }

    .team-link { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer; }
    .team-link img { width: 50px; height: 50px; object-fit: contain; transition: 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .team-link:hover img { transform: rotate(15deg) scale(1.2); filter: drop-shadow(0 0 12px var(--neon-blue)); }
    .team-link span { font-weight: 800; font-family: 'Orbitron'; font-size: 11px; text-align: center; }

    .score-display { font-family: 'Orbitron'; font-size: 2.2rem; font-weight: 900; color: var(--neon-green); }
    .score-live { color: var(--neon-red); animation: pulse 1s infinite; text-shadow: 0 0 15px var(--neon-red); }
#date-selector {
    display: flex;
    justify-content: center; /* K√∂z√©pre igaz√≠tja a gombokat a k√°rty√°k tengely√©ben */
    align-items: center;
    gap: 12px;
    margin: 10px auto 25px auto;
    padding: 10px;
    max-width: 600px; /* Hogy ne legyen sz√©lesebb, mint a meccsk√°rty√°k */
    flex-wrap: nowrap;
    overflow-x: auto;
    scrollbar-width: none; /* Firefox-hoz */
}
#date-selector::-webkit-scrollbar {
    display: none;
}    
.date-btn {
    background: rgba(255, 255, 255, 0.03); /* Ugyanaz a h√°tt√©r, mint a card-n√°l */
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.5);
    padding: 12px 20px;
    border-radius: 12px; /* Meccsk√°rtya lekerek√≠t√©s√©hez igaz√≠tva */
    font-family: 'Orbitron', sans-serif;
    font-size: 11px;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    min-width: 90px;
    text-align: center;
    flex-shrink: 0;
}

/* Hover √°llapot - finom neon k√©k */
.date-btn:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(0, 243, 255, 0.4);
    color: #fff;
}

/* Akt√≠v/Kijel√∂lt √°llapot - Er≈ës neon k√©k √©s √°rny√©k */
.date-btn.active {
    background: rgba(0, 243, 255, 0.15);
    border-color: #00f3ff;
    color: #00f3ff;
    box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
    font-weight: 800;
    transform: translateY(-2px); /* Kicsit kiemelkedik */
}
    /* --- Odds Gombok (Jav√≠tott) --- */
    .match-odds-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; width: 100%; }

    .odds-btn {
        background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border); border-radius: 12px;
        padding: 12px; display: flex; flex-direction: column; align-items: center; gap: 4px;
        color: white; cursor: pointer; transition: 0.2s;
    }
    .odds-btn:hover { background: rgba(14, 165, 233, 0.2); border-color: var(--neon-blue); transform: translateY(-1px); }
    .odds-label { font-size: 10px; opacity: 0.6; font-family: 'Inter'; }
    .odds-val { font-family: 'Orbitron'; font-size: 13px; font-weight: bold; color: var(--neon-green); }

    /* --- G√≥l Villog√°s --- */
    @keyframes goal-flash {
        0% { background-color: rgba(255, 62, 62, 0.95); transform: scale(1.02); }
        50% { background-color: rgba(255, 62, 62, 0.3); transform: scale(1); }
        100% { background-color: rgba(255, 62, 62, 0.95); transform: scale(1.02); }
    }
    .match-card.goal-highlight, .match-card.goal-highlight div, .match-card.goal-highlight span {
        animation: goal-flash 0.5s ease-in-out infinite !important;
        color: white !important; border-color: #ffffff !important;
    }
    .match-card.goal-highlight { z-index: 1000; position: relative; box-shadow: 0 0 50px rgba(255, 62, 62, 0.8); }

    /* --- Tabella St√≠lusok --- */
    .standings-table { width: 100%; border-collapse: separate; border-spacing: 0 6px; }
    .standings-table td { padding: 14px 8px; background: rgba(255,255,255,0.03); text-align: center; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); font-size: 12px; }
    .pos-col { border-left-width: 5px !important; border-left-style: solid !important; }
    .pos-num-box { width: 34px; height: 34px; line-height: 34px; margin: 0 auto; border-radius: 8px; font-weight: 900; font-family: 'Orbitron'; font-size: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

    /* --- Liga V√°laszt√≥ & D√°tum --- */
  #league-list {
    width: 100%;
}

.league-item {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center; /* Becsukva k√∂z√©pen az ikon */
    padding: 12px 0;
    cursor: pointer;
    transition: all 0.3s ease;
    border-left: 3px solid transparent;
}

.sidebar:hover .league-item,
.sidebar.open .league-item {
    justify-content: flex-start;
    padding: 12px 15px;
}

/* IKON WRAPPER - hogy ne ugr√°ljon */
.league-icon-wrapper {
    width: 46px;
    height: 46px;
    min-width: 46px; /* Garant√°lja, hogy ne nyom√≥djon √∂ssze */
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    flex-shrink: 0;
}

.league-icon-wrapper img {
    width: 30px;
    height: 30px;
    object-fit: contain;
}

/* --- SZ√ñVEGEK FINOM KEZEL√âSE --- */
.header-text {
    font-family: 'Orbitron';
    font-size: 13px;
    color: var(--neon-blue);
    opacity: 0;
    width: 0;
    overflow: hidden;
    white-space: nowrap;
    transition: opacity 0.3s ease, width 0.3s ease;
    margin-left: 10px;
}
.league-name-text {
    opacity: 0;
    width: 0;
    margin-left: 0;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis; /* HA T√öL HOSSZ√ö A N√âV, H√ÅROM PONT LESZ (...) */
    font-family: 'Orbitron';
    font-size: 11px;
    color: #fff;
    transition: opacity 0.3s ease, width 0.3s ease, margin-left 0.3s ease;
}        

/* Nyit√°skor a sz√∂veg megjelen√≠t√©se */
.sidebar:hover .header-text,
.sidebar.open .header-text,
.sidebar:hover .league-name-text,
.sidebar.open .league-name-text { 
    opacity: 1;
    visibility: visible;
    width: auto;
    margin-left: 5px;
}

/* --- AKT√çV √âS HOVER √ÅLLAPOTOK --- */
.league-item:hover .league-icon-wrapper,
.league-item.active .league-icon-wrapper {
    background: rgba(14, 165, 233, 0.2);
    border-color: var(--neon-blue);
    box-shadow: 0 0 10px rgba(14, 165, 233, 0.3);
}

.league-item.active {
    background: rgba(0, 255, 136, 0.05);
    border-left: 3px solid var(--neon-green);
}

.league-item:hover {
    background: rgba(255, 255, 255, 0.03);
}
    .date-strip { display: flex; gap: 12px; margin-bottom: 25px; overflow-x: auto; scrollbar-width: none; width: 100%; }
    .date-pill { flex: 0 0 auto; padding: 10px 18px; border-radius: 12px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); cursor: pointer; font-family: 'Orbitron'; font-size: 10px; }
    .date-pill.active { border-color: var(--neon-green); color: var(--neon-green); background: rgba(0,255,136,0.05); }

.sexy-tooltip {
    position: fixed; /* Absolute helyett fixed */
    width: 280px;
    background: rgba(15, 15, 26, 0.98);
    border: 1px solid #00b7ff;
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
    z-index: 10001; /* Extra magas, hogy minden felett legyen */
    opacity: 0;
    visibility: hidden;
    pointer-events: auto; /* Hogy r√° lehessen vinni az egeret */
    transition: opacity 0.3s ease;
}

.sexy-tooltip.active {
    opacity: 1;
    visibility: visible;
}

.tooltip-header {
    font-size: 10px;
    font-weight: 900;
    color: var(--neon-blue);
    letter-spacing: 2px;
    margin-bottom: 8px;
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    padding-bottom: 5px;
}

.tooltip-table {
    width: 100%;
    font-size: 11px;
    color: white;
    border-collapse: collapse;
}

.tooltip-table th {
    color: #888;
    text-align: left;
    font-size: 9px;
    padding-bottom: 5px;
}

.tooltip-table td {
    padding: 6px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.neon-green {
    color: #00ff99;
    font-weight: bold;
    text-shadow: 0 0 5px rgba(0, 255, 153, 0.5);
}


/* Chat Kont√©ner a meccsk√°rty√°n bel√ºl */
.match-chat-section {
    border-top: 1px solid var(--border);
    margin-top: 15px;
    padding-top: 15px;
    display: none; /* Alapb√≥l rejtve */
}

.chat-messages {
    height: 150px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding-right: 5px;
    margin-bottom: 10px;
}

/* √úzenet bubor√©k */
.chat-bubble {
    background: rgba(255, 255, 255, 0.05);
    padding: 8px 12px;
    border-radius: 12px;
    font-size: 12px;
    max-width: 90%;
    border-left: 3px solid var(--neon-blue);
}

.chat-user {
    font-weight: bold;
    font-family: 'Orbitron';
    font-size: 10px;
    display: block;
    margin-bottom: 3px;
}

/* Beviteli mez≈ë */
.chat-input-area {
    display: flex;
    gap: 10px;
}

.chat-input {
    flex: 1;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: white;
    padding: 8px 12px;
    font-size: 12px;
}

.chat-input:focus {
    border-color: var(--neon-blue);
    outline: none;
}

.chat-send-btn {
    background: var(--neon-blue);
    border: none;
    border-radius: 8px;
    width: 35px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Chat gomb a k√°rty√°n */
.btn-chat-toggle {
    cursor: pointer;
    font-family: 'Orbitron';
    font-size: 10px;
    color: var(--text);
    opacity: 0.6;
    transition: 0.3s;
}

.btn-chat-toggle:hover {
    opacity: 1;
    color: var(--neon-blue);
}


        
    /* --- Mobil N√©zet --- */
    .mobile-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 70px; background: var(--glass); display: none; justify-content: space-around; align-items: center; z-index: 1100; border-top: 1px solid var(--border); backdrop-filter: blur(20px); }
    
    @media (max-width: 1100px) {
        .sidebar { 
        position: fixed; 
        left: 0; 
        top: 75px; 
        width: 0px; /* Mobilon teljesen elrejthetj√ºk */
        height: calc(100% - 145px); 
    }
        .main-wrapper { padding-bottom: 70px; }
        .mobile-nav { display: flex; }
        .standings-sidebar { width: 85%; }
    }
       .sidebar.open .header-text,
.sidebar.open .league-item span { 
    opacity: 1;
    visibility: visible;
    transition: opacity 0.4s ease 0.2s; /* K√©sleltetve jelenik meg, miut√°n a sidebar m√°r t√°gul */
}
        #date-selector {
        justify-content: flex-start; /* Mobilon jobb, ha sz√©lr≈ël indul a g√∂rget√©s miatt */
        padding-left: 20px;
    }
    .date-btn {
        padding: 10px 15px;
        min-width: 80px;
    }
    .mobile-nav-container {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 60px;
        background: rgba(20, 20, 30, 0.95);
        backdrop-filter: blur(10px);
        display: flex;
        justify-content: space-around;
        align-items: center;
        z-index: 9999;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: env(safe-area-inset-bottom); /* iOS bar fix */
    }
      body {
        padding-bottom: 70px;
    }

    /* Elcs√∫sz√°s g√°tl√°sa: ne engedj√ºk az oldals√≥ g√∂rget√©st */
    html, body {
        overflow-x: hidden;
        width: 100%;
        position: relative;
    }  
    </style>
</head>
<body>

   <div id="goal-banner">
        <div style="display: flex; align-items: center; gap: 15px;">
            <img id="goal-logo" src="" alt="" style="width: 40px; height: 40px; object-fit: contain; display: none;">
            <div style="display: flex; flex-direction: column;">
                <div id="goal-team-name" style="font-size: 0.9rem; font-weight: 700; color: #000; font-family: 'Orbitron';"></div>
                <div id="goal-text">GOOOAAAL!!!</div>
            </div>
        </div>
    </div>
    
    <audio id="goal-sound" preload="auto">
        <source src="driken5482-applause-cheer-236786.mp3" type="audio/mpeg">
    </audio>

    <div class="bg-animation">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <nav>
        <div class="logo">LUCKYPITCH</div>
        <div class="nav-tools">
            <div id="balance-wrap" style="display: none; font-family: 'Orbitron'; color: var(--neon-green); font-weight: bold;">
                <span id="user-balance">0</span> LP
            </div>
            <button class="tool-btn" onclick="toggleLang()" id="lang-btn">HU</button>
            <button class="tool-btn" onclick="toggleTheme()" id="theme-btn">‚òÄÔ∏è</button>
            <a href="/home" class="tool-btn" style="text-decoration:none;">VISSZA</a>
            <div id="auth-container">
                <div id="user-button"></div>
            </div>
        </div>
    </nav>

    <div class="main-wrapper">
        <aside class="sidebar" id="sidebar-leagues">
            <div class="sidebar-header">
                <span class="header-emoji">üèÜ</span>
                <span class="header-text">BAJNOKS√ÅGOK</span>
            </div>
            <div id="league-list">
                </div>
        </aside>

        <main class="content-area">
            <div id="date-selector" style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; padding: 10px; overflow-x: auto;">
    </div>
<div id="match-container"></div>
        </main>

        <aside class="standings-sidebar" id="sidebar-standings">
            <div class="sidebar-header">üìä √âl≈ë Tabella</div>
            <div id="standings-target">
                <p style="text-align:center; opacity:0.3; margin-top:100px; font-family:'Orbitron'; font-size:10px;">V√ÅLASSZ EGY CSAPATOT</p>
            </div>
        </aside>
    </div>

     <div class="mobile-nav">
        <button class="tool-btn" id="m-leagues" onclick="toggleM('sidebar-leagues')">LIG√ÅK</button>
        <button class="tool-btn" id="m-matches" onclick="closeM()">MECCSEK</button>
        <button class="tool-btn" id="m-table" onclick="toggleM('sidebar-standings')">TABELLA</button>
    </div>

    <script>
// --- 1. GLOB√ÅLIS √ÅLLAPOT ---
let currentLang = localStorage.getItem('lp_lang') || 'HU';
const todayStr = new Date().toLocaleDateString('sv');
let selectedDate = new Date().toISOString().split('T')[0];
let savedLeagues = localStorage.getItem('lp_selectedLeagues');
let selectedLeagues = new Set();
let allMatches = [];
let prevScores = new Map();
let flashingMatches = new Set();
let globalOdds = []; // Itt t√°roljuk az API-b√≥l j√∂tt oddsokat
let activeBets = JSON.parse(localStorage.getItem('lp_activeBets')) || [];
let currentLeagueId = 'all'; // Alapb√≥l minden liga
let isFirstLoad = true; // Seg√©dv√°ltoz√≥ a legtetej√©re
        
// --- 2. SEG√âDF√úGGV√âNYEK ---
function getStatusColor(status) {
    if (!status) return 'transparent';
    const s = status.toLowerCase();
    if (s.includes('champions league')) return '#0044ff';
    if (s.includes('premier league')) return '#0044ff';
    if (s.includes('europa league')) return '#cc7a00';
    if (s.includes('conference league')) return '#00cc6a';
    if (s.includes('relegation')) return '#ff3e3e';
    return 'transparent';
}

function translateStatus(status) {
    if (currentLang !== 'HU') return status;
    const s = status.toLowerCase();
    if (s.includes('champions league')) return 'BL Z√≥na';
    if (s.includes('premier league')) return 'PL feljut√°si Z√≥na';
    if (s.includes('relegation')) return 'Kies≈ë hely';
    return status;
}

async function updateData() {
    try {
        // 1. Meccsek let√∂lt√©se
        const res = await fetch("/live-matches");
        const data = await res.json();
        allMatches = (data && Array.isArray(data.matches)) ? data.matches : (Array.isArray(data) ? data : []);

       // 2. Oddsok let√∂lt√©se - JAV√çTOTT R√âSZ
        try {
            console.log("Odds lek√©r√©se folyamatban...");
            const oddsRes = await fetch("/api/odds-data");
            
            if (!oddsRes.ok) {
                throw new Error(`HTTP hiba! St√°tusz: ${oddsRes.status}`);
            }

            const oddsData = await oddsRes.json();
            console.log("Nyers odds adat a szerverr≈ël:", oddsData); // Itt l√°tni fogjuk, ha √ºres

            // Ellen≈ërizz√ºk, hogy az oddsData t√©nylegesen meccseket tartalmaz√≥ t√∂mb-e
            if (oddsData && Array.isArray(oddsData)) {
                globalOdds = oddsData;
            } else if (oddsData && oddsData.data && Array.isArray(oddsData.data)) {
                // N√©ha az API-k egy "data" objektumba csomagolj√°k a t√∂mb√∂t
                globalOdds = oddsData.data;
            } else {
                console.warn("Az odds form√°tum nem megfelel≈ë vagy √ºres.");
                globalOdds = [];
            }
            
            console.log("globalOdds felt√∂ltve, hossza:", globalOdds.length);
            } catch (e) { 
            console.error("Odds API hiba r√©szletei:", e); 
            globalOdds = [];
        }
        // 3. Automatikus kijel√∂l√©s logik√°ja (Csak az els≈ë sikeres bet√∂lt√©sn√©l)
        if (isFirstLoad && allMatches.length > 0) {
            allMatches.forEach(m => {
                if (m.competition && m.competition.id) {
                    selectedLeagues.add(String(m.competition.id));
                }
            });
            isFirstLoad = false; // Kikapcsoljuk, hogy a user sz≈±r√©se megmaradjon
        }

        // 4. Renderel√©s
        // A DateStrip-et nem kell minden alkalommal √∫jrarajzolni, ha nem v√°ltozott a nap
        if (typeof renderDateStrip === 'function') renderDateStrip();
        
        // Lig√°k √©s meccsek friss√≠t√©se
        if (typeof renderLeagues === 'function') renderLeagues();
        if (typeof renderMatches === 'function') renderMatches();

        // 5. Ellen≈ërz√©sek
        if (allMatches.length > 0) {
            if (typeof checkGoals === 'function') checkGoals();
            if (typeof checkBetResults === 'function') checkBetResults();
        }

        console.log("Adatok friss√≠tve. Meccsek:", allMatches.length);

    } catch (e) {
        console.error("Hiba az updateData fut√°sakor:", e);
    }
}
// --- 3. EGYENLEG √âS AUTH ---
async function refreshBalance() {
    if (window.Clerk && Clerk.user) {
        try {
            const res = await fetch(`/api/user/balance?userId=${Clerk.user.id}`);
            const data = await res.json();
            const bSpan = document.getElementById('user-balance');
            const bWrap = document.getElementById('balance-wrap');
            if (bSpan) bSpan.innerText = Number(data.balance || 0).toLocaleString();
            if (bWrap) bWrap.style.display = 'flex';
        } catch (e) { console.error("Balance fetch error:", e); }
    }
}

function checkGoals() {
    if (!allMatches || !Array.isArray(allMatches)) return;

    allMatches.forEach(match => {
        const matchId = match.id;
        const currentScore = (match.score && match.score.fullTime) ? 
            `${match.score.fullTime.home}-${match.score.fullTime.away}` : "0-0";

        if (prevScores.has(matchId) && prevScores.get(matchId) !== currentScore) {
            const oldScore = prevScores.get(matchId);
            const [oldH, oldA] = oldScore.split('-').map(Number);
            const [newH, newA] = currentScore.split('-').map(Number);

            // G√ìL √âSZLEL√âSE
            let scoringTeam = null;
            if (newH > oldH) scoringTeam = match.homeTeam.name;
            if (newA > oldA) scoringTeam = match.awayTeam.name;

            if (scoringTeam) {
                // 1. Vizu√°lis effekt (eredeti k√≥dod)
                if (typeof triggerGoalEffect === 'function') {
                    triggerGoalEffect(matchId, scoringTeam, newH > oldH ? match.homeTeam.crest : match.awayTeam.crest);
                }

                // 2. C√çMSOR (TITLE) FRISS√çT√âSE
                const originalTitle = document.title;
                const goalTitle = `‚öΩ G√ìL: ${scoringTeam} (${newH}:${newA}) ‚öΩ`;
                
                document.title = goalTitle;

                // 10 m√°sodperc ut√°n vissza√°ll√≠tjuk az eredeti c√≠met
                setTimeout(() => {
                    document.title = "LUCKYPITCH | Ultimate Live Tracker";
                }, 10000);
            }
        }
        prevScores.set(matchId, currentScore);
    });
}
// --- DINAMIKUS EFFEKT (Ha ez is hi√°nyozna) ---

function triggerGoalEffect(mId, tName, logo) {
    const b = document.getElementById('goal-banner');
    const sound = document.getElementById('goal-sound');

    // --- √öJ R√âSZ: Meccsk√°rtya villogtat√°s ind√≠t√°sa ---
    if (typeof flashingMatches !== 'undefined') {
        const stringId = String(mId);
        flashingMatches.add(stringId);

        // √öjrarajzoljuk a meccseket, hogy megkapja a 'goal-highlight' oszt√°lyt
        if (typeof renderMatches === 'function') renderMatches();

        // 10 m√°sodperc ut√°n levessz√ºk a villog√°st
        setTimeout(() => {
            flashingMatches.delete(stringId);
            if (typeof renderMatches === 'function') renderMatches();
        }, 10000);
    }
    // ------------------------------------------------

    if (b) {
        document.getElementById('goal-team-name').innerText = tName;

        const logoImg = document.getElementById('goal-logo');
        if (logoImg) {
            logoImg.src = logo || 'default-logo.png'; 
            logoImg.style.display = logo ? 'block' : 'none';
        }

        b.classList.add('show');

        if (sound) { 
            sound.currentTime = 0; 
            sound.play().catch(e => console.warn("Hang lej√°tsz√°sa hiba:", e)); 
        }

        setTimeout(() => b.classList.remove('show'), 5000);
    }
}

// --- 4. ADATKEZEL√âS ---        
async function checkBetResults() {
    if (!activeBets || activeBets.length === 0) return;

    let updatedAny = false;

    for (let i = activeBets.length - 1; i >= 0; i--) {
        const bet = activeBets[i];

        // Megkeress√ºk a meccset az √©l≈ë adatok k√∂z√∂tt
        const match = allMatches.find(m => String(m.id) === String(bet.matchId));

        if (match && match.status === "FINISHED") {
            const homeScore = match.score.fullTime.home;
            const awayScore = match.score.fullTime.away;
            let won = false;

            // Nyert-e a tipp?
            if (bet.type === 'H' && homeScore > awayScore) won = true;
            else if (bet.type === 'D' && homeScore === awayScore) won = true;
            else if (bet.type === 'V' && awayScore > homeScore) won = true;

            if (won) {
                const prize = Math.floor(bet.amount * bet.odds);
                const newTotal = window.userBalance + prize;

                alert(`GRATUL√ÅLUNK! üéâ\nA(z) ${match.homeTeam.name} meccsen nyert√©l ${prize} LP-t!`);

                // Friss√≠tj√ºk a Supabase-t
                await updateSupabaseBalance(newTotal);
            } else {
                alert(`Sajnos nem nyert√©l... ‚ùå\nA(z) ${match.homeTeam.name} meccs v√©geredm√©nye: ${homeScore}:${awayScore}`);
            }

            // T√∂r√∂lj√ºk az akt√≠v fogad√°sok k√∂z√ºl, mert lez√°rult
            activeBets.splice(i, 1);
            updatedAny = true;
        }
    }

    if (updatedAny) {
        localStorage.setItem('lp_activeBets', JSON.stringify(activeBets));
        renderMatches();
    }
}

// Seg√©df√ºggv√©ny a Supabase friss√≠t√©shez
async function updateSupabaseBalance(newAmount, betData = null) {
    try {
        const res = await fetch('/api/user/update-balance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                userId: Clerk.user.id, 
                balance: newAmount,
                bet: betData // Itt k√ºldj√ºk el a fogad√°s r√©szleteit is!
            })
        });

        if (res.ok) {
            window.userBalance = newAmount;
            const balanceElem = document.getElementById('user-balance');
            if (balanceElem) balanceElem.innerText = newAmount.toLocaleString();
            return true;
        }
    } catch (e) {
        console.error("Hiba a szerverrel val√≥ kommunik√°ci√≥ sor√°n:", e);
        return false;
    }
}

function getSmartOdds(match) {
    const seed = match.id || 0;
    const rng = (s) => Math.abs(Math.sin(seed + s));

    let result = {
        h: (1.4 + rng(1) * 2).toFixed(2),
        d: (2.8 + rng(2) * 1.5).toFixed(2),
        a: (1.6 + rng(3) * 3).toFixed(2)
    };

    if (!globalOdds || globalOdds.length === 0) return result;

    const clean = (name) => {
        if (!name) return "";
        return name.toLowerCase()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .replace(/\bfc\b|\bafc\b|\bcf\b|\bclub\b|\batletico\b|\batl.\b|\bsports\b|\bfr\b/g, '') // FR-t is kivessz√ºk
            .replace(/[^a-z0-9]/g, ' ') // Nem t√∂r√∂lj√ºk a sz√≥k√∂z√∂ket, csak a fura karaktereket
            .trim();
    };

    const mHome = clean(match.homeTeam.name);
    const mAway = clean(match.awayTeam.name);

    // Keres√©s finom√≠t√°sa
    const found = globalOdds.find(o => {
        const oHome = clean(o.home_team);
        const oAway = clean(o.away_team);

        // Ellen≈ërizz√ºk, hogy a szavak √°tfedik-e egym√°st (pl. "Botafogo FR" vs "Botafogo")
        const isHomeMatch = oHome.includes(mHome) || mHome.includes(oHome);
        const isAwayMatch = oAway.includes(mAway) || mAway.includes(oAway);

        return isHomeMatch && isAwayMatch;
    });

    if (found && found.bookmakers?.[0]) {
        const market = found.bookmakers[0].markets.find(m => m.key === 'h2h');
        
        if (market) {
            // Itt a kimeneteleket a csapatn√©v alapj√°n p√°ros√≠tjuk az API-b√≥l j√∂v≈ë eredeti nevekkel
            market.outcomes.forEach(outcome => {
                const outName = clean(outcome.name);
                if (outName.includes(clean(found.home_team)) || clean(found.home_team).includes(outName)) {
                    result.h = outcome.price.toFixed(2);
                } else if (outName.includes(clean(found.away_team)) || clean(found.away_team).includes(outName)) {
                    result.a = outcome.price.toFixed(2);
                } else if (outName.includes('draw') || outName === 'x' || outName.includes('remis')) {
                    result.d = outcome.price.toFixed(2);
                }
            });
        }
    }
    return result;
}

// --- 5. MEGJELEN√çT√âS ---
async function renderMatches() {
    const cont = document.getElementById("match-container");
    if (!cont) return;

    if (!allMatches || allMatches.length === 0) {
        cont.innerHTML = `<p style="text-align:center; padding:50px; opacity:0.3;">${currentLang==='HU'?'ADATOK BET√ñLT√âSE...':'LOADING MATCHES...'}</p>`;
        return;
    }

    // --- 1. FOGAD√ÅSOK LEK√âR√âSE ---
    let currentUserBets = [];
    if (typeof Clerk !== 'undefined' && Clerk.user) {
        try {
            const response = await fetch(`/api/user/bets?userId=${Clerk.user.id}&t=${Date.now()}`);
            if (response.ok) {
                currentUserBets = await response.json();
                localStorage.setItem('lp_activeBets', JSON.stringify(currentUserBets));
            } else {
                currentUserBets = JSON.parse(localStorage.getItem('lp_activeBets') || '[]');
            }
        } catch (err) {
            currentUserBets = JSON.parse(localStorage.getItem('lp_activeBets') || '[]');
        }
    }

    // --- 2. D√ÅTUMV√ÅLASZT√ì √âS SZ≈∞R√âS ---
    if (typeof renderDateSelector === 'function') renderDateSelector(); 

    const filtered = allMatches.filter(m => {
        if (!m || !m.utcDate || !m.competition) return false;
        const mDate = m.utcDate.split('T')[0];
        const mLeagueId = String(m.competition.id);
        const isCorrectDate = (mDate === selectedDate);
        const isCorrectLeague = (selectedLeagues.size === 0 || selectedLeagues.has(mLeagueId));
        return isCorrectDate && isCorrectLeague;
    });

    // Ha nincs meccs, ki√≠rjuk √©s MEG√ÅLLUNK
    if (filtered.length === 0) {
        cont.innerHTML = `<p style="text-align:center; padding:50px; opacity:0.3; font-family:'Orbitron'; font-size:12px;">NINCS MECCS EKKOR: ${selectedDate}</p>`;
        return;
    }

    // Rendez√©s (Jav√≠tott szintaxis)
    filtered.sort((a, b) => {
        const dateA = new Date(a.utcDate).getTime();
        const dateB = new Date(b.utcDate).getTime();
        if (dateA !== dateB) return dateA - dateB;
        return String(a.id).localeCompare(String(b.id));
    });

    // --- 3. RENDEREL√âS ---
    cont.innerHTML = filtered.map(m => {
        try {
            const isLive = ["IN_PLAY", "LIVE", "PAUSED"].includes(m.status);
            const isFinished = ["FINISHED", "AWARDED"].includes(m.status);
            const mDateObj = new Date(m.utcDate);
            const timeStr = mDateObj.toLocaleTimeString('hu-HU',{hour:'2-digit',minute:'2-digit'});

            const score = (isLive || isFinished) && m.score && m.score.fullTime
                ? `${m.score.fullTime.home}:${m.score.fullTime.away}` 
                : timeStr;

            const odds = typeof getSmartOdds === 'function' ? getSmartOdds(m) : {h:1.50, d:3.20, a:2.40};
            const myBet = currentUserBets.find(b => String(b.match_id || b.matchId) === String(m.id));
            const isFlashing = (typeof flashingMatches !== 'undefined' && flashingMatches.has(String(m.id))) ? 'goal-highlight' : '';
            const bStatus = myBet ? String(myBet.status).toUpperCase() : null;

            return `
                <div class="match-card ${isFlashing}" id="match-${m.id}" style="display: flex; flex-direction: column; align-items: center; padding: 15px; margin-bottom: 12px; position: relative; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                    ${myBet ? `
                        <div style="position: absolute; top: 0; left: 0; background: ${bStatus === 'WON' ? '#00ff88' : bStatus === 'LOST' ? '#ff3e3e' : '#ffaa00'}; color: black; font-size: 8px; font-weight: bold; padding: 2px 6px; border-bottom-right-radius: 6px; font-family: 'Orbitron'; z-index:10;">
                            ${bStatus === 'WON' ? 'WINNER' : bStatus === 'LOST' ? 'LOST' : 'LIVE BET'}
                        </div>
                    ` : ''}
                    <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; margin-bottom: 15px;">
                        <div class="team-link" style="flex: 1; display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer;" onclick="if(typeof showStandings==='function') showStandings(${m.competition.id}, ${m.homeTeam.id}, '${m.competition.code}')">
                            <img src="${m.homeTeam.crest || ''}" style="width: 35px; height: 35px; object-fit: contain; margin-bottom: 5px;" onerror="this.src='https://via.placeholder.com/40'">
                            <span style="font-size: 11px; font-weight: 500;">${m.homeTeam.name}</span>
                        </div>
                        <div style="flex: 0 0 80px; text-align: center;">
                            <div class="score-display ${isLive ? 'score-live' : ''}" style="font-size: 18px; font-weight: 800; font-family: 'Orbitron';">${score}</div>
                            ${isLive ? '<div class="pulse-red" style="font-size: 8px; color: #ff3e3e; margin-top: 2px;">LIVE</div>' : ''}
                            <a href="/elemzes?id=${m.id}" class="tool-btn" style="font-size: 7px; margin-top: 8px; display: inline-block;">ELEMZ√âS</a>
                        </div>
                        <div class="team-link" style="flex: 1; display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer;" onclick="if(typeof showStandings==='function') showStandings(${m.competition.id}, ${m.awayTeam.id}, '${m.competition.code}')">
                            <img src="${m.awayTeam.crest || ''}" style="width: 35px; height: 35px; object-fit: contain; margin-bottom: 5px;" onerror="this.src='https://via.placeholder.com/40'">
                            <span style="font-size: 11px; font-weight: 500;">${m.awayTeam.name}</span>
                        </div>
                    </div>
                    <div class="bet-section" style="width: 100%; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 12px;">
                        ${myBet ? `
                            <div style="background: ${bStatus === 'WON' ? 'rgba(0, 255, 136, 0.1)' : bStatus === 'LOST' ? 'rgba(255, 62, 62, 0.1)' : 'rgba(255, 170, 0, 0.1)'}; 
                                        border: 1px dashed ${bStatus === 'WON' ? '#00ff88' : bStatus === 'LOST' ? '#ff3e3e' : '#ffaa00'}; 
                                        border-radius: 6px; width: 100%; padding: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="font-size: 9px; color: ${bStatus === 'WON' ? '#00ff88' : bStatus === 'LOST' ? '#ff3e3e' : '#ffaa00'}; display: block; font-family: 'Orbitron';">
                                        ${bStatus === 'WON' ? 'NYERTES' : bStatus === 'LOST' ? 'VESZTETT' : (myBet.type || 'LIVE') + ' TIPP'}
                                    </span>
                                    <span style="font-size: 13px; font-weight: bold;">${Number(myBet.amount).toLocaleString()} LP</span>
                                </div>
                                <div style="text-align: right;">
                                    <span style="font-size: 13px; font-weight: bold; color: ${bStatus === 'LOST' ? '#ff3e3e' : '#00ff88'};">
                                        ${bStatus === 'LOST' ? '0' : Math.floor(myBet.amount * myBet.odds).toLocaleString()} LP
                                    </span>
                                </div>
                            </div>
                        ` : (m.status === 'TIMED' || m.status === 'SCHEDULED') ? `
                            <div style="display: flex; gap: 8px; width: 100%;">
                                <button class="odds-btn" style="flex:1;" onclick="placeBet(${m.id}, '${m.homeTeam.name.replace(/'/g, "\\'")}', ${odds.h}, 'H')">H ${odds.h}</button>
                                <button class="odds-btn" style="flex:1;" onclick="placeBet(${m.id}, 'D√∂ntetlen', ${odds.d}, 'D')">D ${odds.d}</button>
                                <button class="odds-btn" style="flex:1;" onclick="placeBet(${m.id}, '${m.awayTeam.name.replace(/'/g, "\\'")}', ${odds.a}, 'V')">V ${odds.a}</button>
                            </div>
                        ` : `
                            <div style="text-align:center; font-size: 10px; opacity: 0.5; font-family: 'Orbitron';">${isLive ? '√âL≈ê MECCS - LEZ√ÅRVA' : 'FOGAD√ÅS LEZ√ÅRVA'}</div>
                        `}
                    </div>
                </div>`;
        } catch (err) {
            console.error("Hiba egy k√°rtya gener√°l√°sakor:", err);
            return '';
        }
    }).join('');
}
// --- √öJ F√úGGV√âNY: LIG√ÅK KEZEL√âSE ---
function toggleLeague(leagueId, element) {
    if (selectedLeagues.has(leagueId)) {
        selectedLeagues.delete(leagueId);
        element.classList.remove('active');
    } else {
        selectedLeagues.add(leagueId);
        element.classList.add('active');
    }
    
    // Ha minden lig√°t kivett√ºnk, vizu√°lisan olyan, mintha minden be lenne jel√∂lve
    // Vagy ha azt akarod, hogy kattint√°sra friss√ºlj√∂n:
    renderMatches();
}

// --- 6. UI LOGIKA ---
function renderDateSelector() {
    const selector = document.getElementById("date-selector");
    if (!selector || !allMatches || allMatches.length === 0) return;

    const datesSet = new Set();
    allMatches.forEach(m => {
        if (m.utcDate) datesSet.add(m.utcDate.split('T')[0]);
    });
    
    const sortedDates = Array.from(datesSet).sort();

    selector.innerHTML = sortedDates.map(date => {
        const dObj = new Date(date);
        const isActive = date === selectedDate;
        // Felt√©telezve, hogy a todayStr defini√°lva van glob√°lisan
        const isToday = (typeof todayStr !== 'undefined' && date === todayStr);
        const label = isToday ? 'MA' : dObj.toLocaleDateString('hu-HU', { weekday: 'short', day: 'numeric' });

        return `
            <button class="date-btn ${isActive ? 'active' : ''}" onclick="selectedDate='${date}'; renderMatches();">
                ${label.toUpperCase()}
            </button>`;
    }).join('');
}

async function placeBet(matchId, teamName, odds, type) {
    // 1. BEL√âP√âS ELLEN≈êRZ√âSE
    if (typeof Clerk === 'undefined' || !Clerk.user) {
        alert("A fogad√°shoz el≈ëbb be kell jelentkezned!");
        Clerk.openSignIn({ afterSignInUrl: window.location.href });
        return;
    }

    // 2. √ñSSZEG BEK√âR√âSE
    const amountStr = prompt(`Mennyit teszel a k√∂vetkez≈ëre: ${teamName}? (Szorz√≥: ${odds})`, "100");
    if (amountStr === null) return; 

    const amount = parseInt(amountStr);
    if (isNaN(amount) || amount <= 0) {
        alert("K√©rlek adj meg egy √©rv√©nyes √∂sszeget!");
        return;
    }

    // 3. EGYENLEG ELLEN≈êRZ√âSE
    if (amount > window.userBalance) {
        alert(`Nincs el√©g egyenleged! Jelenlegi: ${window.userBalance} LP`);
        return;
    }

    try {
        const newBalance = window.userBalance - amount;

        // --- A TR√úKK: CSAK EGYETLEN H√çV√ÅS A SZERVERNEK ---
        // Itt nem haszn√°ljuk a 'supabase' v√°ltoz√≥t, mert a backend elint√©zi!
        const res = await fetch('/api/user/update-balance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                userId: Clerk.user.id, 
                balance: newBalance,
                // Bek√ºldj√ºk a fogad√°s adatait is, a backend majd ebb≈ël ment a Supabase-be
                bet: {
                    matchId: String(matchId),
                    teamName: teamName,
                    amount: amount,
                    odds: odds,
                    type: type
                }
            })
        });

        if (res.ok) {
            // SIKER: UI √©s Helyi adatok friss√≠t√©se
            window.userBalance = newBalance;
            const balanceElem = document.getElementById('user-balance');
            if (balanceElem) balanceElem.innerText = newBalance.toLocaleString();

            // LocalStorage-ba is elmentj√ºk a "LIVE BET" jelv√©ny miatt
            let currentBets = JSON.parse(localStorage.getItem('lp_activeBets') || '[]');
            currentBets.push({
                matchId: String(matchId),
                teamName: teamName,
                amount: amount,
                odds: odds,
                status: 'OPEN'
            });
            localStorage.setItem('lp_activeBets', JSON.stringify(currentBets));

            alert(`Sikeres fogad√°s!`);
            if (typeof renderMatches === 'function') renderMatches();
        } else {
            throw new Error("A szerver elutas√≠totta a k√©r√©st.");
        }
    } catch (err) {
        console.error("Hiba:", err);
        alert("Hiba t√∂rt√©nt a ment√©s sor√°n. K√©rlek pr√≥b√°ld √∫jra!");
    }
}

async function checkBetResults() {
    // 1. Beolvassuk a helyi fogad√°sokat
    let currentBets = JSON.parse(localStorage.getItem('lp_activeBets') || '[]');
    if (currentBets.length === 0) return;

    let changed = false;

    for (let bet of currentBets) {
        // Csak a m√©g nyitott fogad√°sokat n√©zz√ºk
        if (bet.status !== 'OPEN') continue;

        // Megkeress√ºk a meccset az √©l≈ë adatok k√∂z√∂tt
        const match = allMatches.find(x => String(x.id) === String(bet.matchId));

        // Ha a meccs v√©get √©rt (FINISHED)
        if (match && (match.status === 'FINISHED' || match.status === 'AWARDED')) {
            const homeScore = match.score.fullTime.home;
            const awayScore = match.score.fullTime.away;
            let actualWinner = '';

            if (homeScore > awayScore) actualWinner = 'H';
            else if (homeScore < awayScore) actualWinner = 'V';
            else actualWinner = 'D';

            if (bet.type === actualWinner) {
                // --- NYERT! ---
                const prize = Math.floor(bet.amount * bet.odds);
                console.log(`GRATUL√ÅLOK! Nyert√©l ${prize} LP-t a ${bet.teamName} meccsen!`);

                // J√≥v√°√≠rjuk a szerveren √©s a kliensen is
                await processWin(prize, bet.matchId);
                bet.status = 'WON';
            } else {
                // --- VESZTETT ---
                console.log(`Sajnos a ${bet.teamName} fogad√°sod nem j√∂tt be.`);
                bet.status = 'LOST';
            }
            changed = true;
        }
    }

    // Ha t√∂rt√©nt v√°ltoz√°s, elmentj√ºk √©s √∫jrarajzolunk
    if (changed) {
        localStorage.setItem('lp_activeBets', JSON.stringify(currentBets));
        if (typeof renderMatches === 'function') renderMatches();
    }
}

async function processWin(prizeAmount, matchId) {
    try {
        // Kisz√°moljuk az √∫j egyenleget
        const newBalance = window.userBalance + prizeAmount;

        const res = await fetch('/api/user/update-balance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: Clerk.user.id,
                balance: newBalance,
                // Opcion√°lisan k√ºldhet√ºnk egy megjegyz√©st a szervernek
                note: `Nyerem√©ny a(z) ${matchId} azonos√≠t√≥j√∫ meccsr≈ël`
            })
        });

        if (res.ok) {
            window.userBalance = newBalance;
            // Friss√≠tj√ºk a kijelz≈ët
            const balanceElem = document.getElementById('user-balance');
            if (balanceElem) balanceElem.innerText = newBalance.toLocaleString();
        }
    } catch (err) {
        console.error("Hiba a nyerem√©ny j√≥v√°√≠r√°sakor:", err);
    }
}

// --- EGYENLEG MENT√âSE AZ ADATB√ÅZISBA ---
async function saveBalanceToDB(userId, newBalance) {
    try {
        const res = await fetch('/api/user/update-balance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                userId: userId, 
                balance: newBalance // Itt a teljes √∫j √∂sszeget k√ºldj√ºk
            })
        });
        if (!res.ok) throw new Error("Database update failed");
        console.log("Egyenleg elmentve a Supabase-be:", newBalance);
    } catch (e) {
        console.error("Hiba a ment√©s sor√°n:", e);
    }
}

// --- EGYENLEG BET√ñLT√âSE IND√çT√ÅSKOR ---
async function loadInitialBalance() {
    if (!Clerk.user) return;

    try {
        const response = await fetch(`/api/user/balance?userId=${Clerk.user.id}`);
        const data = await response.json();

        if (data && data.balance !== undefined) {
            const balanceSpan = document.getElementById('user-balance');
            const balanceWrap = document.getElementById('balance-wrap'); // EZT ADTUK HOZZ√Å

            if (balanceSpan) {
                balanceSpan.innerText = Number(data.balance).toLocaleString();
            }

            // Itt tessz√ºk l√°that√≥v√° a dobozt!
            if (balanceWrap) {
                balanceWrap.style.display = 'flex'; 
            }

            window.userBalance = data.balance; 
        }
    } catch (err) {
        console.error("Hiba az egyenleg megjelen√≠t√©sekor:", err);
    }
}

async function showStandings(leagueId, teamId, code, isAutoCall = false) {
    const sidebar = document.querySelector('.standings-sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    const target = document.getElementById("standings-target");

    // 1. Sidebar √©s mobil n√©zet kezel√©se
    if (sidebar && !isAutoCall) {
        sidebar.classList.add('open');
        if (overlay) overlay.classList.add('active');
        // Mobilon g√∂rget√©s tilt√°sa a h√°tt√©rben, ha nyitva a tabella
        document.body.style.overflow = 'hidden'; 
    }

    if (!target) return;
    target.innerHTML = `<div class="loading-spinner">LOADING...</div>`;

    try {
        // Query param√©ter tiszt√≠t√°sa (fontos, hogy az API nagybet≈±t v√°rhat)
        const queryParam = (code || leagueId)?.toString().toUpperCase();
        if (!queryParam) throw new Error("Nincs √©rv√©nyes azonos√≠t√≥");

        const res = await fetch(`/api/standings/${queryParam}`);
        if (!res.ok) throw new Error(`Szerver hiba: ${res.status}`);
        
        const data = await res.json();

        // R√©szletes adatellen≈ërz√©s
        if (!data || !data.standings || !Array.isArray(data.standings) || data.standings.length === 0) {
            throw new Error("A tabella jelenleg nem el√©rhet≈ë ehhez a lig√°hoz.");
        }

        const standings = data.standings.find(s => s.type === 'TOTAL') || data.standings[0];
        const tableData = standings.table;
        if (!tableData) throw new Error("√úres t√°bl√°zat.");

        const total = tableData.length;
        const isHU = typeof currentLang !== 'undefined' && currentLang === 'HU';

        let html = `<table class="standings-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th style="text-align:left">${isHU ? 'CSAPAT' : 'TEAM'}</th>
                            <th>P</th>
                        </tr>
                    </thead>
                    <tbody>`;

        tableData.forEach(r => {
            let status = r.description || "";
            const pos = r.position;
            const currentTeamId = r.team.id;
            const isTarget = teamId && currentTeamId == teamId;

            // Z√≥na logika be√©p√≠t√©se
            if (!status || status === "") {
                if (['PL', 'PD', 'SA'].includes(code)) {
                    if (pos <= 4) status = "Champions League Group Stage";
                    else if (pos === 5) status = "Europa League Group Stage";
                    else if (pos === 6) status = "Conference League Qualifiers";
                    else if (pos >= total - 2) status = "Relegation";
                } else if (code === 'BL1') {
                    if (pos <= 4) status = "Champions League Group Stage";
                    else if (pos === 5) status = "Europa League Group Stage";
                    else if (pos === 16) status = "Oszt√°lyoz√≥";
                    else if (pos >= 17) status = "Relegation";
                } else if (code === 'DED') { 
                    if (pos <= 2) status = "Champions League Group Stage";
                    else if (pos === 3) status = "Champions League Qualifiers";
                    else if (pos === 4) status = "Europa League Qualifiers";
                    else if (pos >= 5 && pos <= 8) status = "Conference League Play-offs";
                    else if (pos === 16) status = "Oszt√°lyoz√≥";
                    else if (pos >= 17) status = "Relegation";
                }   else if (code === 'FL1') {
                    if (pos <= 3) status = "Champions League Group Stage";
                    else if (pos === 4) status = "Champions League Qualifiers";
                    else if (pos === 5) status = "Europa League Group Stage";
                    else if (pos === 16) status = "Oszt√°lyoz√≥";
                    else if (pos >= 17) status = "Relegation";
                } else if (code === 'PPL') {
                            if (pos === 1) status = "Champions League Group Stage";
                            else if (pos === 2) status = "Champions League Qualifiers";
                            else if (pos === 3) status = "Europa League Qualifiers";
                            else if (pos === 4) status = "Conference League Qualifiers";
                            else if (pos === 16) status = "Oszt√°lyoz√≥";
                            else if (pos >= 17) status = "Relegation"; 
                } else if (code === 'ELC') {
                            if (pos <= 2) status = "Feljut√°s - Premier League";
                            else if (pos <= 6) status = "Play-off (Championship)";
                            else if (pos >= total - 2) status = "Relegation";
                }else {
                    if (pos === 1) status = "Bajnok / Feljut√≥";
                    else if (pos >= total - 2) status = "Relegation";
                }
            }

            const color = typeof getStatusColor === 'function' ? getStatusColor(status) : 'transparent';
            const boxBg = color !== 'transparent' ? color : 'rgba(255,255,255,0.05)';
            const boxText = color !== 'transparent' ? '#000' : 'var(--neon-blue)';

            html += `
                <tr class="${isTarget ? 'highlight-row' : ''}">
                    <td class="pos-col" style="border-left: 3px solid ${color}">
                        <div class="pos-num-box" style="background:${boxBg}; color:${boxText};">
                            ${pos}
                        </div>
                    </td>
                    <td style="text-align:left;">
                        <div class="team-flex">
                            <img src="${r.team.crest}" width="20" height="20" loading="lazy" onerror="this.src='placeholder.png'">
                            <span class="t-name ${isTarget ? 'bold' : ''}">${r.team.shortName || r.team.name}</span>
                        </div>
                    </td>
                    <td class="points-col">${r.points}</td>
                </tr>`;
        });

        target.innerHTML = html + "</tbody></table>";

    } catch (e) { 
        console.error("Standings Error:", e);
        target.innerHTML = `
            <div class="error-msg">
                <p>‚ö†Ô∏è ${e.message}</p>
            </div>`; 
    }
}
        
function updateStaticTexts() {
    const isHU = currentLang === 'HU';
    const langBtn = document.getElementById('lang-btn');
    const hLeagues = document.getElementById('h-leagues');
    const hTable = document.getElementById('h-table');
    const backLink = document.getElementById('back-link');

    if (langBtn) langBtn.innerText = currentLang;
    if (hLeagues) hLeagues.innerText = isHU ? 'üèÜ Bajnoks√°gok' : 'üèÜ Leagues';
    if (hTable) hTable.innerText = isHU ? 'üìä √âl≈ë Tabella' : 'üìä Live Standings';
    if (backLink) backLink.innerText = isHU ? 'VISSZA' : 'BACK';

    // Mobil gombok
    const mLeagues = document.getElementById('m-leagues');
    const mMatches = document.getElementById('m-matches');
    const mTable = document.getElementById('m-table');
    if (mLeagues) mLeagues.innerText = isHU ? 'LIG√ÅK' : 'LEAGUES';
    if (mMatches) mMatches.innerText = isHU ? 'MECCSEK' : 'MATCHES';
    if (mTable) mTable.innerText = isHU ? 'TABELLA' : 'TABLE';

    const placeholder = document.getElementById('standings-placeholder');
    if (placeholder) placeholder.innerText = isHU ? 'V√ÅLASSZ EGY CSAPATOT' : 'CHOOSE A TEAM';
}
// Nyelv v√°lt√°sa (HU <-> EN)
function toggleLang() {
    currentLang = currentLang === 'HU' ? 'EN' : 'HU';
    saveState(); // Elmentj√ºk a v√°laszt√°st
    updateStaticTexts(); // Friss√≠tj√ºk a feliratokat (üèÜ Bajnoks√°gok, stb.)
    renderMatches(); // √öjrarajzoljuk a meccseket az √∫j nyelven
    s();
    renderDateStrip();

    // Friss√≠tj√ºk a gomb felirat√°t is
    const langBtn = document.getElementById('lang-btn');
    if (langBtn) langBtn.innerText = currentLang;
}

// S√∂t√©t/Vil√°gos m√≥d v√°lt√°sa
function toggleTheme() {
    document.body.classList.toggle('light');
    const themeBtn = document.getElementById('theme-btn');
    if (themeBtn) {
        themeBtn.innerText = document.body.classList.contains('light') ? 'üåô' : '‚òÄÔ∏è';
    }
    // Elmentj√ºk a v√°laszt√°st a b√∂ng√©sz≈ëbe
    localStorage.setItem('lp_theme', document.body.classList.contains('light') ? 'light' : 'dark');
}

// Oldal bet√∂lt√©sekor ellen≈ërizz√ºk, volt-e mentett t√©ma
if (localStorage.getItem('lp_theme') === 'light') {
    document.body.classList.add('light');
    window.addEventListener('load', () => {
        if (document.getElementById('theme-btn')) document.getElementById('theme-btn').innerText = 'üåô';
    });
}

function renderLeagues() {
   const listContainer = document.getElementById("league-list");
    if (!listContainer) return;

    // CSAK az adott naphoz tartoz√≥ meccseket n√©zz√ºk a liga-list√°hoz
    const matchesOnSelectedDate = allMatches.filter(m => {
        const mDate = m.utcDate.split('T')[0];
        return mDate === selectedDate;
    });

    const unique = new Map();
    matchesOnSelectedDate.forEach(m => {
        if (m.competition && m.competition.id) {
            unique.set(String(m.competition.id), m.competition);
        }
    });

    const leagueItemsHtml = [...unique.values()].map(l => {
        const idStr = l.id.toString();
        // Akkor akt√≠v, ha a Set-ben benne van, VAGY ha a Set √ºres (ekkor minden akt√≠v)
        const isActive = selectedLeagues.has(idStr);
        
        return `
            <div class="league-item ${isActive ? 'active' : ''}" 
                 onclick="handleLeagueClick('${idStr}')">
                <div class="league-icon-wrapper">
                    <img src="${l.emblem}" alt="${l.name}" onerror="this.src='https://via.placeholder.com/32?text=?'">
                </div>
                <span class="league-name-text">${l.name}</span>
            </div>`;
    }).join('');

    listContainer.innerHTML = leagueItemsHtml;
}

// Seg√©df√ºggv√©ny, hogy ne legyen t√∫l hossz√∫ az onclick
function toggleLeagueSelection(id) {
    if (selectedLeagues.has(id)) {
        selectedLeagues.delete(id);
    } else {
        selectedLeagues.add(id);
    }
    renderLeagues();
    renderMatches(); // Friss√≠tj√ºk a k√∂z√©ps≈ë r√©szt is!
}
        
async function loadUserBetsFromServer() {
    if (typeof Clerk === 'undefined' || !Clerk.user) return;

    try {
        const response = await fetch(`/api/user/bets?userId=${Clerk.user.id}`);

        // Itt volt a hiba: 'res' helyett 'response' kell mindenhol!
        const text = await response.text(); 
        console.log("Szerver v√°lasza:", text); 

        if (!response.ok) {
            console.error(`Szerver hiba: ${response.status}`);
            return;
        }

        try {
            const bets = JSON.parse(text);
            if (Array.isArray(bets)) {
                localStorage.setItem('lp_activeBets', JSON.stringify(bets));
                // Csak akkor renderel√ºnk, ha t√©nyleg v√°ltozott valami
                if (typeof renderMatches === 'function') renderMatches();
            }
        } catch (parseErr) {
            console.error("A szerver v√°lasza nem √©rv√©nyes JSON! Val√≥sz√≠n≈±leg HTML hibaoldalt kapt√°l.");
        }

    } catch (e) {
        console.warn("H√°l√≥zati hiba:", e);
    }
}

// --- 7. IND√çT√ÅS ---
let isInitialized = false;

// 1. MECCSEK √âS UI IND√çT√ÅSA
function initSiteFunctions() {
    if (typeof updateUI === 'function') updateUI(); 
    if (typeof initNeural === 'function') initNeural(); 
    if (typeof fetchMatches === 'function') fetchMatches(); 
    if (typeof startCounters === 'function') startCounters();
    
    if (typeof updateData === 'function') updateData();
    if (typeof checkBetResults === 'function') checkBetResults(); 

    if (typeof renderDateStrip === 'function') renderDateStrip();
    if (typeof renderLeagues === 'function') renderLeagues();
    if (typeof renderMatches === 'function') renderMatches();

    setInterval(() => {
        if (typeof updateData === 'function') updateData();
        if (typeof checkBetResults === 'function') checkBetResults();
    }, 30000);
}

// 2. A CLERK KEZEL√âSE
async function startApp() {
    if (localStorage.getItem('theme') === 'light') document.body.classList.add('light');

    initSiteFunctions(); // Meccsek azonnal

    let t = 0;
    while (typeof Clerk === 'undefined' && t < 50) { 
        await new Promise(r => setTimeout(r, 100)); 
        t++; 
    }

    if (typeof Clerk !== 'undefined') {
        try {
            await Clerk.load({ routing: 'virtual' });

            // FIGYEL≈ê JAV√çT√ÅSA:
            Clerk.addListener(({ user, client }) => {
                // Csak akkor reloadolunk, ha:
                // 1. M√°r be volt t√∂ltve minden (isInitialized)
                // 2. NINCS user (user === null)
                // 3. √âS nincs folyamatban l√©v≈ë bejelentkez√©si k√≠s√©rlet (client.signIn.status !== 'needs_first_factor')
                // Ez megv√©di az e-mail k√≥dos ablakot!
                
                const isSigningIn = client && client.signIn && client.signIn.status === 'needs_first_factor';
                const isSigningUp = client && client.signUp && client.signUp.status === 'missing_requirements';

                if (isInitialized && user === null && !isSigningIn && !isSigningUp) {
                    console.log("Val√≥di kijelentkez√©s, mehet a reload.");
                    localStorage.removeItem('lp_activeBets');
                    window.location.href = '/meccsek.html';
                }
            });

            if (Clerk.user) {
                const userBtn = document.getElementById('user-button');
                if(userBtn) {
                    Clerk.mountUserButton(userBtn, {
                        afterSignOutUrl: window.location.origin + '/meccsek.html'
                    });
                }
                if (typeof loadInitialBalance === 'function') await loadInitialBalance(); 
                const authLinks = document.getElementById('auth-links');
                if (authLinks) authLinks.style.display = 'none';
            } else {
                const lb = document.getElementById('login-btn');
                if (lb) { 
                    lb.style.display = 'block'; 
                    lb.onclick = (e) => {
                        e.preventDefault(); 
                        e.stopImmediatePropagation();
                        Clerk.openSignIn({ 
                            routing: 'virtual',
                            afterSignInUrl: window.location.origin + '/meccsek.html',
                            afterSignUpUrl: window.location.origin + '/meccsek.html'
                        });
                    };
                }
            }
            
            // Csak a legv√©g√©n aktiv√°ljuk a figyel≈ët
            isInitialized = true; 

        } catch (error) {
            console.error("Clerk error:", error);
        }
    }
}

window.onload = startApp;
        
// --- MOBIL NAVIG√ÅCI√ì JAV√çT√ÅSA ---
function toggleM(id) { 
    // Minden oldals√°v bez√°r√°sa el≈ësz√∂r
    document.querySelectorAll('.sidebar, .standings-sidebar').forEach(s => {
        s.classList.remove('open');
    });
    // Csak a kiv√°lasztott megnyit√°sa
    const target = document.getElementById(id);
    if (target) target.classList.add('open'); 
}

function closeM() { 
    // Minden oldals√°v bez√°r√°sa (a MECCSEK gombhoz)
    document.querySelectorAll('.sidebar, .standings-sidebar').forEach(s => {
        s.classList.remove('open');
    });
}
function saveState() {
    const state = {
        selectedLeagues: Array.from(selectedLeagues),
        selectedDate: selectedDate,
        currentLang: typeof currentLang !== 'undefined' ? currentLang : 'hu'
    };

    try {
        localStorage.setItem('lucky_pitch_state', JSON.stringify(state));
        console.log("√Ållapot elmentve.");
    } catch (e) {
        console.warn("Nem siker√ºlt menteni a localStorage-ba:", e);
    }
}

let startX = 0;
let startY = 0;
let isDragging = false;

const sbLeft = document.querySelector('.sidebar');
const sbRight = document.querySelector('.standings-sidebar');

// 1. Overlay check (marad a ti√©d)
if(!document.querySelector('.sidebar-overlay')) {
    const ov = document.createElement('div');
    ov.className = 'sidebar-overlay';
    document.body.appendChild(ov);
    ov.addEventListener('click', closeAllSidebars);
}
const overlay = document.querySelector('.sidebar-overlay');

function closeAllSidebars() {
    sbLeft.classList.remove('open');
    sbRight.classList.remove('open');
    overlay.classList.remove('active');
    document.body.style.cursor = 'default';
    isDragging = false;

    // FIX: Visszaadjuk a g√∂rget√©st a f≈ëoldalnak
    document.body.style.overflow = ''; 
}

// 2. K√ñZ√ñS LOGIKA: Ez d√∂nti el a diffX alapj√°n, mi t√∂rt√©njen
function handleAction(endX, endY, sX, sY) {
    const diffX = endX - sX;
    const diffY = endY - sY;

    // Csak ha v√≠zszintes a mozg√°s √©s el√©g hossz√∫ (80px)
    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 80) {
        if (diffX > 0) { // JOBBRA H√öZ√ÅS
            if (sX < 100) { // Bal sz√©lr≈ël ind√≠tva -> Lig√°k nyit√°sa
                sbLeft.classList.add('open');
                overlay.classList.add('active');
            } else if (sbRight.classList.contains('open')) { // Tabella bez√°r√°sa
                closeAllSidebars();
            }
        } else { // BALRA H√öZ√ÅS
            if (sX > window.innerWidth - 100) { // Jobb sz√©lr≈ël ind√≠tva -> Tabella nyit√°sa
                sbRight.classList.add('open');
                overlay.classList.add('active');
            } else if (sbLeft.classList.contains('open')) { // Lig√°k bez√°r√°sa
                closeAllSidebars();
            }
        }
    }
}

// 3. EGYS√âGES√çTETT ESEM√âNYKEZEL≈êK
const startAction = (e) => {
    const posX = e.type.includes('mouse') ? e.pageX : e.changedTouches[0].screenX;
    const posY = e.type.includes('mouse') ? e.pageY : e.changedTouches[0].screenY;
    
    // Csak a sz√©leken (100px) vagy ha m√°r nyitva van valamelyik s√°v
    if (posX < 100 || posX > window.innerWidth - 100 || sbLeft.classList.contains('open') || sbRight.classList.contains('open')) {
        startX = posX;
        startY = posY;
        isDragging = true;
        if (e.type.includes('mouse')) document.body.style.cursor = 'grabbing';
    }
};

const moveAction = (e) => {
    if (!isDragging) return;
    
    // Megakad√°lyozzuk az oldal "el√∫sz√°s√°t" (feh√©r s√°v fix)
    // Csak akkor vonjuk el az ir√°ny√≠t√°st, ha sz√©lr≈ël indult a swipe
    if (startX < 100 || startX > window.innerWidth - 100 || sbLeft.classList.contains('open') || sbRight.classList.contains('open')) {
        if (e.cancelable) e.preventDefault();
    }
};

const endAction = (e) => {
    if (!isDragging) return;
    
    const endX = e.type.includes('mouse') ? e.pageX : e.changedTouches[0].screenX;
    const endY = e.type.includes('mouse') ? e.pageY : e.changedTouches[0].screenY;
    
    handleAction(endX, endY, startX, startY);
    
    isDragging = false;
    document.body.style.cursor = 'default';
};

// --- FELIRATKOZ√ÅS ---

// Eg√©r
document.addEventListener('mousedown', startAction);
document.addEventListener('mousemove', moveAction);
document.addEventListener('mouseup', endAction);

// Mobil (Touch)
document.addEventListener('touchstart', startAction, {passive: true});
document.addEventListener('touchmove', moveAction, {passive: false}); // Fontos a false a preventDefault miatt!
document.addEventListener('touchend', endAction, {passive: true});

// --- PROFIL HOVER TIPP T√ÅBL√ÅZAT JAV√çTOTT VERZI√ì ---

function initSexyTooltip() {
    if (document.getElementById('user-tips-tooltip')) return;

    const tooltip = document.createElement('div');
    tooltip.id = 'user-tips-tooltip';
    tooltip.className = 'sexy-tooltip';
    tooltip.innerHTML = `
        <div class="tooltip-header">AKTU√ÅLIS TIPPJEID</div>
        <table class="tooltip-table">
            <thead>
                <tr>
                    <th>Meccs</th>
                    <th>Tipp</th>
                    <th>Odds</th>
                </tr>
            </thead>
            <tbody id="tooltip-tips-body">
                <tr><td colspan="3" style="text-align:center; padding:10px;">Bet√∂lt√©s...</td></tr>
            </tbody>
        </table>
    `;
    document.body.appendChild(tooltip);

  let hideTimeout;

    // 2. Clerk UserButton megkeres√©se (mivel dinamikusan t√∂lt≈ëdik be)
    const findClerkInterval = setInterval(() => {
        const userBtn = document.querySelector('.cl-userButtonTrigger');
        
        if (userBtn) {
            clearInterval(findClerkInterval);

            // Megnyit√°s az ikonra vitelkor
            userBtn.addEventListener('mouseenter', () => {
                clearTimeout(hideTimeout);
                updateTooltipData(); // Adatok lek√©r√©se a Supabase-b≈ël
                
                const rect = userBtn.getBoundingClientRect();
                const tooltipWidth = 280;
                
                // FIXED POZ√çCI√ì: Csak a l√°that√≥ ablakhoz viszony√≠tunk
                // √çgy g√∂rget√©skor is az ikon alatt marad
                let top = rect.bottom + 10; 
                let left = rect.left + (rect.width / 2) - (tooltipWidth / 2);

                // Sz√©l ellen≈ërz√©s (ne l√≥gjon ki a k√©perny≈ër≈ël)
                if (left < 10) left = 10;
                if (left + tooltipWidth > window.innerWidth - 10) {
                    left = window.innerWidth - tooltipWidth - 10;
                }

                tooltip.style.top = top + 'px';
                tooltip.style.left = left + 'px';
                tooltip.classList.add('active');
            });

            // Bez√°r√°s k√©sleltetve, ha elhagyjuk az ikont
            userBtn.addEventListener('mouseleave', () => {
                hideTimeout = setTimeout(() => {
                    tooltip.classList.remove('active');
                }, 300);
            });

            // Ha a t√°bl√°zatra vissz√ºk az egeret, maradjon kint
            tooltip.addEventListener('mouseenter', () => {
                clearTimeout(hideTimeout);
            });

            // Ha elhagyjuk a t√°bl√°zatot is, akkor t≈±nj√∂n el
            tooltip.addEventListener('mouseleave', () => {
                tooltip.classList.remove('active');
            });
        }
    }, 1000); 
}

// Adatok bet√∂lt√©se
async function updateTooltipData() {
    const body = document.getElementById('tooltip-tips-body');
    if (!body) return;

    try {
        const userId = window.Clerk?.user?.id;
        if (!userId) {
            body.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:10px;">Jelentkezz be!</td></tr>';
            return;
        }

        const response = await fetch(`/api/user/bets?userId=${userId}`);
        const bets = await response.json();

        // Debug info a konzolra
        console.log("Be√©rkez≈ë adatok:", bets);

        if (!bets || bets.length === 0) {
            body.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:15px; color:#888;">Nincsenek tippjeid.</td></tr>';
            return;
        }

        // Itt NEM sz≈±r√ºnk d√°tumra, csak sorbarendezz√ºk (ha a backend nem tenn√© meg) 
        // √©s kivessz√ºk a legutols√≥ 7-et
        const latestBets = bets.slice(0, 7);

        body.innerHTML = latestBets.map(bet => {
            // St√°tusz alap√∫ sz√≠nk√≥dok (OPEN = sz√ºrke/k√©k, WON = z√∂ld, LOST = piros)
            let statusColor = '#ccc';
            if (bet.status === 'WON') statusColor = '#00ff99';
            if (bet.status === 'LOST') statusColor = '#ff4d4d';
            if (bet.status === 'OPEN') statusColor = '#00b7ff';

            return `
                <tr>
                    <td style="max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding: 6px 0; font-size: 11px;">
                        ${bet.team_name}
                    </td>
                    <td style="color: var(--neon-blue); font-weight: bold; text-align: center; font-size: 11px;">
                        ${bet.type || '-'}
                    </td>
                    <td style="text-align: right; font-family: 'Orbitron'; font-weight: bold; color: ${statusColor}; font-size: 11px;">
                        ${bet.odds}
                    </td>
                </tr>
            `;
        }).join('');

    } catch (err) {
        console.error("Hiba az adatok megjelen√≠t√©sekor:", err);
        body.innerHTML = '<tr><td colspan="3" style="text-align:center; color: red; padding:10px;">Hiba t√∂rt√©nt...</td></tr>';
    }
}
// Futtat√°s ind√≠t√°sa
initSexyTooltip();

// LIGA KATTINT√ÅS JAV√çTOTT LEZ√ÅR√ÅSA
document.querySelectorAll('.league-item').forEach(item => {
    item.addEventListener('click', () => {
        const leagueId = item.getAttribute('data-league-id');

        if (typeof currentLeagueId !== 'undefined' && currentLeagueId === leagueId) {
            currentLeagueId = 'all';
            item.classList.remove('active');
        } else {
            document.querySelectorAll('.league-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            currentLeagueId = leagueId;
        }
        
        if (typeof renderMatches === 'function') renderMatches();
    });
});
function handleLeagueClick(id) {
    const idStr = String(id);
    
    // V√°lt√°s: ha benne van kivessz√ºk, ha nincs betessz√ºk
    if (selectedLeagues.has(idStr)) {
        selectedLeagues.delete(idStr);
    } else {
        selectedLeagues.add(idStr);
    }

    // AZONNALI vizu√°lis visszajelz√©s (nem v√°runk az API-ra)
    renderLeagues(); 
    renderMatches(); 
}
// Socket inicializ√°l√°sa
const socket = io();

function toggleChat(matchId) {
    const section = document.getElementById(`chat-section-${matchId}`);
    if (section.style.display === 'none' || !section.style.display) {
        section.style.display = 'block';
        socket.emit('join-chat', matchId);
    } else {
        section.style.display = 'none';
    }
}

function sendChatMessage(matchId) {
    const input = document.getElementById(`chat-input-${matchId}`);
    const message = input.value.trim();
    
    if (message) {
        socket.emit('send-msg', {
            matchId: matchId,
            user: "Te", // Ide j√∂hetne a j√∫zer val√≥di neve
            message: message,
            color: '#0ea5e9'
        });
        input.value = '';
    }
}

// √öj √ºzenet √©rkez√©sekor
socket.on('new-msg', (data) => {
    const container = document.querySelector(`#chat-messages-${data.matchId}`);
    if (container) {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'chat-bubble';
        msgDiv.innerHTML = `
            <span class="chat-user" style="color: ${data.color}">${data.user}</span>
            <span class="chat-text">${data.message}</span>
        `;
        container.appendChild(msgDiv);
        container.scrollTop = container.scrollHeight; // G√∂rget√©s az alj√°ra
    }
});
function onGoalScored(matchId, teamName, newScore) {
    // Rendszer√ºzenet k√ºld√©se a chatbe mindenkin√©l
    io.to(`match_${matchId}`).emit('new-msg', {
        user: "üèüÔ∏è STADION",
        message: `G√ì√ì√ì√ìL! ${teamName} betal√°lt! √Åll√°s: ${newScore}`,
        color: "#ff3e3e" // Neon piros a g√≥lnak
    });
}
        
    </script>
</body>
</html>

















































































































