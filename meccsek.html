<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuckyPitch | Live Pro</title>
    <style>
        :root {
            --primary: #00ff88;
            --bg: #0b121e;
            --card-bg: #161c2d;
            --text: #ffffff;
            --text-dim: #94a3b8;
            --live: #ff4444;
        }
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 20px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* Navigáció */
        .nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { color: var(--primary); text-transform: uppercase; letter-spacing: 4px; margin: 0; font-size: 22px; }
        
        /* Dátum gombok */
        .date-selector { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .date-btn {
            background: var(--card-bg); border: 1px solid var(--primary); color: var(--text);
            padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 13px; white-space: nowrap;
        }
        .date-btn.active { background: var(--primary); color: #000; font-weight: bold; }

        /* Liga szekciók */
        .league-section { background: var(--card-bg); border-radius: 12px; margin-bottom: 20px; overflow: hidden; border: 1px solid rgba(0,255,136,0.1); }
        .league-header { padding: 12px 15px; background: rgba(255,255,255,0.05); font-weight: bold; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .crest { width: 20px; height: 20px; object-fit: contain; }

        /* Meccs sorok */
        .match-row { 
            display: grid; grid-template-columns: 1fr 80px 1fr; align-items: center; 
            padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.03); 
            transition: background 0.5s;
        }
        .team-box { display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .team-box.home { justify-content: flex-end; text-align: right; }
        
        .score-box { text-align: center; }
        .score { font-size: 18px; font-weight: bold; color: var(--primary); display: block; }
        .status-tag { font-size: 10px; text-transform: uppercase; color: var(--text-dim); }
        .status-tag.live { color: var(--live); font-weight: bold; animation: pulse 2s infinite; }

        /* Progress Bar */
        .bar { width: 40px; height: 3px; background: #222; margin: 4px auto; border-radius: 2px; }
        .progress { height: 100%; background: var(--primary); width: 0%; transition: 1s linear; }

        /* Gól villanás */
        .goal-flash { background: rgba(0, 255, 136, 0.2) !important; animation: flash-fade 2s; }
        @keyframes flash-fade { from { background: rgba(0, 255, 136, 0.4); } to { background: transparent; } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-bar">
        <h1>LuckyPitch</h1>
        <div id="clock" style="font-size: 12px; color: var(--text-dim);"></div>
    </div>

    <div id="date-selector" class="date-selector"></div>
    <div id="app">Betöltés...</div>
</div>

<script>
    let allMatches = [];
    let lastScores = {};
    let selectedDate = new Date().toISOString().split('T')[0];

    async function load() {
        try {
            const res = await fetch("/live-matches?" + Date.now());
            const data = await res.json();
            allMatches = data.matches || [];
            render();
            if (allMatches.length > 0) createDateButtons();
        } catch (e) { console.error("Szerver hiba"); }
    }

    function createDateButtons() {
        const selector = document.getElementById("date-selector");
        if (selector.children.length > 0) return; // Ne generálja újra percenként
        
        const today = new Date();
        [-1, 0, 1, 2].forEach(diff => {
            const d = new Date(today);
            d.setDate(today.getDate() + diff);
            const iso = d.toISOString().split('T')[0];
            const label = (d.getMonth() + 1).toString().padStart(2, '0') + "." + d.getDate().toString().padStart(2, '0');
            
            const btn = document.createElement("div");
            btn.className = `date-btn ${iso === selectedDate ? 'active' : ''}`;
            btn.innerText = label;
            btn.onclick = () => {
                selectedDate = iso;
                document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                render();
            };
            selector.appendChild(btn);
        });
    }

    function getMinute(m) {
        if (m.status === "IN_PLAY") {
            const start = new Date(m.utcDate);
            const diff = Math.floor((Date.now() - start) / 60000);
            return Math.min(Math.max(1, diff), 100);
        }
        return null;
    }

    function render() {
        const app = document.getElementById("app");
        document.getElementById("clock").innerText = new Date().toLocaleTimeString();
        
        const filtered = allMatches.filter(m => m.utcDate.startsWith(selectedDate));
        if (filtered.length === 0) {
            app.innerHTML = "<p style='text-align:center; color:var(--text-dim)'>Nincs meccs ezen a napon.</p>";
            return;
        }

        // Csoportosítás ligák szerint
        const leagues = {};
        filtered.forEach(m => {
            if (!leagues[m.competition.id]) leagues[m.competition.id] = { name: m.competition.name, emblem: m.competition.emblem, matches: [] };
            leagues[m.competition.id].matches.push(m);
        });

        app.innerHTML = "";
        Object.values(leagues).forEach(league => {
            const section = document.createElement("div");
            section.className = "league-section";
            
            let matchHtml = `<div class="league-header"><img src="${league.emblem}" class="crest"> ${league.name}</div>`;
            
            league.matches.forEach(m => {
                const score = `${m.score.fullTime.home ?? 0}-${m.score.fullTime.away ?? 0}`;
                const minute = getMinute(m);
                const isGoal = lastScores[m.id] !== undefined && lastScores[m.id] !== score;
                const statusText = m.status === 'IN_PLAY' ? minute + "'" : (m.status === 'FINISHED' ? 'VÉGE' : m.utcDate.split('T')[1].substring(0,5));

                matchHtml += `
                    <div class="match-row ${isGoal ? 'goal-flash' : ''}" id="m-${m.id}">
                        <div class="team-box home">${m.homeTeam.name} <img src="${m.homeTeam.crest}" class="crest"></div>
                        <div class="score-box">
                            <span class="score">${score}</span>
                            <span class="status-tag ${m.status === 'IN_PLAY' ? 'live' : ''}">${statusText}</span>
                            ${m.status === 'IN_PLAY' ? `<div class="bar"><div class="progress" style="width:${minute}%"></div></div>` : ''}
                        </div>
                        <div class="team-box away"><img src="${m.awayTeam.crest}" class="crest"> ${m.awayTeam.name}</div>
                    </div>
                `;
                lastScores[m.id] = score;
            });
            section.innerHTML = matchHtml;
            app.appendChild(section);
        });
    }

    load();
    setInterval(load, 20000); // 20 másodpercenként frissít
</script>

</body>
</html>
